define(["jquery","jqueryui","core/str"],function(w,e,n){function p(){T=[],C=[],h=!(M=[]);for(var e=0;e<q.length;e++)q[e]=[];A=!1,D()}function r(e,n){var t=0;w("#nameofgroup").show(),1==e&&p(),A=!0,B(),T=[],f=[];var r=[];for(c in h=!0,w("#predicate .criterionWrapper").each(function(){var e=P(w(this).children(".criterion"));e.rule=w(this).find(".boolOper").html(),r.push(e)}),unassignedStudents={},assignedStudents={},w("#unassigned .student").each(function(){var e=/student-(\d+)/.exec(this.id);unassignedStudents[e[1]]=students[e[1]]}),w(".team .student").each(function(){var e=/student-(\d+)/.exec(this.id);assignedStudents[e[1]]=students[e[1]]}),w.each(responses,function(e,n){!1===n&&(delete assignedStudents[e],delete unassignedStudents[e]),t++}),i=0,v=!(_=[]),r){for(a in criterion=r[c],strLine="-"+criterion.rule+":"+questions[criterion.question].question+"<br>value:",_[i]=[],_[i][0]=criterion.rule,_[i][1]="",_[i][2]=criterion.question,criterion.answers)answer=questions[criterion.question].answers[criterion.answers[a]],strLine=strLine+answer.answer+"("+criterion.answers[a]+"),",_[i][1]=_[i][1]+criterion.answers[a]+",";if(_[i][0]==O.distribute&&""==_[i][1])for(qa in questions[criterion.question].answers)_[i][1]=_[i][1]+qa+",";if(_[i][0]==O.aggregate){for(qa in v=!0,b=i,_[i][1]="",w("#aggList").empty(),w("#aggList").append(w("<option>",{value:"",text:""})),questions[criterion.question].answers)_[i][1]=_[i][1]+qa+",",w("#aggList").append(w("<option>",{value:questions[criterion.question].answers[qa].answer.split(" ").join("_"),text:questions[criterion.question].answers[qa].answer}));w("#aggList").css("display",""),w("#aggListTitle").css("display","")}if(_[i][0]==O.balance)for(qa in questions[criterion.question].answers)_[i][1]=_[i][1]+qa+",";_[i][1]=_[i][1].replace(new RegExp("[,]*$"),""),i++,strLine=strLine.replace(new RegExp("[,]*$"),"")}nMaxStudent=Math.ceil(t/S.length),ne(),nbTime=parseInt(6-t/100,10),nbTime<1&&(nbTime=1),5<nbTime&&(nbTime=5);for(var s=0;s<nbTime;s++){for(i=0;i<_.length;i++)switch(_[i][0]){case O.cluster:K(n);break;case O.distribute:E(n);break;case O.aggregate:R(n);break;case O.balance:N(n)}if(U(),n){avgStudentGroup=parseInt(t/q.length);for(var o=0;o<10;o++){for(var u=0,d=0;d<q.length;d++)if(q[d].length>avgStudentGroup)for(k=q[d].length-1;0<=k;k--)if(1==v&&1==f.reduce(function(e,n){return e+(n===q[d][k])},0)){for(l=0;l<q.length;l++)if(q[l].length-q[d].length<-1&&M[l][b]==M[d][b]){q[l].push(q[d][k]),q[d].splice(k,1),k=-1e6,u++;break}}else if(-1==f.indexOf(q[d][k]))for(l=0;l<q.length;l++)if(q[l].length<avgStudentGroup){q[l].push(q[d][k]),q[d].splice(k,1),k=-1e6,u++;break}0==u&&(o=15),U()}for(i=0;i<_.length;i++)if(_[i][0]==O.balance){N(n);break}}f=[]}D(),W(w("#nbteam").val())}function s(){w("#addnewcriterion").on("click",H),w("#buildteams").on("click",function(){w("#protectAll").modal("show"),setTimeout(function(){r(!0,!1),ie(),w("#protectAll").modal("hide")},250)}),w("#resetteams").on("click",function(){p(),ie(),W(0),W(1),w("#nbteam").val(1)}),w("#replay").on("click",function(){w("#protectAll").modal("show"),setTimeout(function(){r(!1,!1),ie(),w("#protectAll").modal("hide")},250)}),w("#assignrandomly").on("click",function(){ne(),ie()}),w("#creategroups").on("click",function(){!function(){B();var e=w('<form action="'+window.location+'" method="POST"></form>');for(i=0;i<S.length;i++){var n=S[i],t=q[i],r=w('<input type="hidden" name="teamnames['+i+']" value="'+n+'" />');e.append(r);var s=w('<input type="hidden" name="teams['+i+']" value="'+t.join(",")+'" />');e.append(s)}var a=w('<input type="hidden" name="action" value="create-groups" />'),o=w('<input type="hidden" name="groupingName" value="'+w("#groupingName").val()+'" />'),l=w('<input type="hidden" name="groupingID" value="'+w("#groupingSelect").val()+'" />'),c=w('<input type="hidden" name="inheritGroupingName" value="'+(w("#inheritGroupingName").is(":checked")?1:0)+'" />'),u=w('<input type="hidden" name="nogrouping" value="'+(w("#nogrouping").is(":checked")?1:0)+'" />');e.append(a),e.append(o),e.append(l),e.append(c),e.append(u),w("#createGroupsForm").append(e),e.submit()}(),ie()}),w("#prettify").on("click",function(){w("#protectAll").modal("show"),setTimeout(function(){r(!1,!0),ie(),w("#protectAll").modal("hide")},250)}),w("#serie").on("click",function(){w("#protectAll").modal("show"),setTimeout(function(){!function(){var e="";w("#nameofgroup").hide();q=[];var n=[];p(),A=h=!0,w("#unassigned .student").each(function(){var e=/student-(\d+)/.exec(this.id);n.push(e[1])});var t=Math.ceil(n.length/S.length),r=0,s=0;for(q[0]=[],i=0;i<n.length;i++)q[r][s]=n[i],t<=++s&&r<S.length-1&&(q[++r]=[],s=0);for(i=0;i<S.length;i++)e=""+(i+1),S[i]=O.serie+" "+"00".substring(0,"00".length-e.length)+e;D()}(),ie(),w("#protectAll").modal("hide")},250)}),w("#dsp_sum_switch").on("click",function(e){w(".box_ok").toggle(),e.stopPropagation()}),w("#aggList").on("click",function(){ce()}),w("#equalize").on("click",function(){J()}),w("#deleteallred").on("click",function(){de()}),w("#keepallred").on("click",function(){pe()})}var y,x=85,q=[],S=[],T=[],I=0,A=!1,O={},o="",f=[],_=[],M=[],u=[],C=[],L=0,d=0,F=0,h=!1,g=!1,v=!1,b=-1,z=function(e,n){var t=n.split("?")[0],r=[],s=-1!==n.indexOf("?")?n.split("?")[1]:"";if(""!==s){for(var a=(r=s.split("&")).length-1;0<=a;a-=1)r[a].split("=")[0]===e&&r.splice(a,1);t=t+"?"+r.join("&")}return t},W=function(e){B();var n=["A-Team","Agent Carter","Agents of S.H.I.E.L.D.","Akatsuki","All-Star Squadron","Alpha Flight","Angel Investigations","Aqua Teen Hunger Force","Arabian Knights","Archer and Armstrong","Armorines","Arrancar","Arrow","Astro Boy","Astro City","Autobots","Avengers","Batman","Battletoads","Ben 10","Beware the Batman","Big Hero 6","Biker Mice from Mars","Bionic Six","Bionic Woman","Birds of Prey","Black Scorpion","Blood Syndicate","Blue Falcon","Champions","Chouseishin","Crystal Gems","Darkstars","Defenders","Dick Tracy","Digvbc","Doom Patrol","Drak Pack","Elementals","Espada 10","Excalibur","Experts of Justice","Fairy Tail Guild","Fantastic 4","Fantastic Force","Fantastic Four","Fearless Defenders","Femforce","Flash","Flash Gordon","Force Works","Forever People","Freedom Fighters","Freedom Force","Freedom Phalanx","Frenetic Five","Future Foundation","Galaxy Angel","Galaxy Trio","Gatchaman","Gatchaman Crowds","Generation X","Gen¹³","Gotei 13","Gotham","Green Lantern Corps","H.A.R.D.Corps","Harbingers","Hero Alliance","Hero Association","Heroes","Heroes for Hire","Inferior Five","Infinity Inc.","Inhumans","Invaders","JLA","Jake 2.0","Jedi","Jessica Jones","Jetman","Justice League","Justice Machine","Kekkaishi","Kickers Inc.","Kiss (band)","Knight Sabers","Lady Blackhawk","Extraordinary Gentlemen","Legends of Tomorrow","Legion of Superheroes","Libra","Lieutenant Marvels","Lois and Clark","Lone Ranger","Lone Ranger Rides Again","Magic Knight Rayearth","Manhattan Clan","Manimal","Marvel Family","Marvel Knights","S.H.I.E.L.D.","Masters of the Universe","Men in Black","Metal Men","Mighty Crusaders","Mighty Mouse","Misfits","Misfits of Science","Mutant X","Mystery Men","Neo-Knights","Nextwave","Nightman","Nova Corps","Omega Men","Overwatch","Planetary","Power Pack","Power Rangers","Preacher","Psi-Force","Ronin Warriors","Runaways","S.H.I.E.L.D.","SWAT Kats","Sailor Senshi","Sailor Senshi","Samurai Pizza Cats","Sarah Solano","Secret Avengers","Secret Six","Section 8","Sentinels of Magic","Seven Soldiers of Victory","Shadowpact","Shi'ar Imperial Guard","Shinigami","Sign Gene","SilverHawks","Sky High","Sora","Sovereign Seven","Spectral Knights","Speedracer","Spider-Friends","Squadron Supreme","Squadron of Justice","Stormwatch","Stormwatch","Straw Hat Pirates","Street Sharks","Suicide Squad","Super Friends","Super Power Friends","Super Sentai","Superboy","Superfriends","Supergirl","Superhuman Samurai","Superman","T.H.U.N.D.E.R. Agents","Team 7","Team Avatar","Team Zenith","Teen Force","Teen Titans","Teenage Mutant Ninja Turtles","Terrific Three","The Aquabats","The Atomics","The Authority","The Avengers","The Beetleborgs","The Care Bears","The Centurions","The DNAgents","The Elite","The End League","The Galaxy Rangers","The Greatest American Hero","The Herculoids","The Impossibles","The Incarnations","The Incredible Hulk","The Incredibles","The Justice Friends","The Legion of Net.Heroes","The Loonatics","The Mighty Ducks","The Mighty Heroes","The N Team","The New League of Heroes","The New Wave","The Order of the Phoenix","The Others","The Outsiders","The Powerpuff Girls","The Six Million Dollar Man","The Specials","The Spectacular Spider-man","The Spider’s Web","The Strangers","The Super Capers","The Super Globetrotters","The Tick","The Tomorrow People","ThunderCats","Thunderbolts","Time Squad","Tokyo Mew Mew","Toxic Crusaders","Turbo-Man","Ultimates","Ultraforce","Uncanny X-Men","Underdog","Underfist","VR Troopers","Watchmen","West Coast Avengers","Wetworks","Wild C.A.T.s","Wolverine and the X-Men","Wonder Woman","X-Factor","X-Force","X-Men","X-Men 2099","X-Statix","Yatterman","Young Allies","Young Avengers","Young Justice","Z Warriors"];if(-1<w("#id_namingscheme").val().indexOf("*")){q.length>e&&(q=q.slice(0,e)),S.length>e&&(S=S.slice(0,e));for(var t=0;t<e;t++){var r=w("#id_namingscheme").val(),s=r;if(-1<r.indexOf("#"))s=r.replace("#",t+1);else if(-1<r.indexOf("@")){for(var a="",i=t;a+=0<=(i-=26)?String.fromCharCode("A".charCodeAt(0)+0):String.fromCharCode("A".charCodeAt(0)+i+26),0<=i;);s=r.replace("@",a)}s=void 0===w("#sumbox_"+t).data("name")||-1<w("#sumbox_"+t).data("name").indexOf("dataname")?s.replace("*",""):s.replace("*",w("#sumbox_"+t).data("name")),S[t]=s}}else if(q.length>e&&(q=q.slice(0,e)),S.length>e)S=S.slice(0,e);else if(S.length<e){var o=[];for(t=0;t<n.length;t++)o[t]=t;for(o=ue(o),t=S.length-1;t<e;t++){if(-1<(r=""!=w("#id_namingscheme").val()?w("#id_namingscheme").val():O.groupTitle).indexOf("#"))s=r.replace("#",t+1);else if(-1<r.indexOf("@")){for(a="",i=t;a+=0<=(i-=26)?String.fromCharCode("A".charCodeAt(0)+0):String.fromCharCode("A".charCodeAt(0)+i+26),0<=i;);s=r.replace("@",a)}else s=-1<r.indexOf("$")?r.replace("$",n[o[t]]):r+(t+1);S[t]=s}}D()},G=function(e){var n=P(e),t=n.boolOper,r=w("#nbteam").val(),s=0,a="";switch(t){case O.cluster:for(var i in students)!1!==responses[i]&&ee(i,n)&&s++;a+=O.analyzeclustercriterion.replace("{nbstudent}",s).replace("{nbteam}",r),a+=s/r<2?O.analyzeclusterwarning:O.analyzeclustersuccess;break;case O.aggregate:var o=0;for(var i in students)!1!==responses[i]&&s++;for(var l in p=[],studAvgByTeam=Math.ceil(s/r),questions[n.question].answers)p.push(l);for(var c=0;c<p.length;c++){for(i in o=0,students)!1!==responses[i]&&-1!=responses[i].indexOf(parseInt(p[c]))&&o++;var u=o%studAvgByTeam,d=parseInt(o/studAvgByTeam);color="",0!=u?(color="red",a+=O.analyzeaggregatewarning.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",o).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u)):(color="green",a+=O.analyzeaggregatewarningOK.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",o).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u))}break;case O.distribute:for(i in students)!1!==responses[i]&&s++;p=[],p=n.answers;for(c=0;c<p.length;c++){for(i in s=0,students)!1!==responses[i]&&(n.answers=[p[c]],ee(i,n)&&s++);status=r<=s?O.analyzedistributesuccess.replace("{nbteam}",r):O.analyzedistributewarning.replace("{nbteam}",r),a+=O.analyzedistributecriterion.replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",s).replace("{status}",status)}break;case O.balance:a="";var p=[];for(l in questions[n.question].answers)p.push(l);n.answers=p;var h=0,g=[];for(i in students)if(aRes=responses[i],!1!==responses[i]&&ee(i,n)){for(s++,c=0;c<p.length&&-1===aRes.indexOf(parseInt(p[c],10));c++);if(h+=parseInt(questions[n.question].answers[p[c]].answer),g.push(parseInt(questions[n.question].answers[p[c]].answer)),0==w.isNumeric(questions[n.question].answers[p[c]].answer)){a=O.analyzebalancewarning,s=0;break}}if(""==a){var f=h/s;a=(a=a+"<br>"+O.total+" : <b>"+h+"</b>")+"<br>"+O.average+" : <b>"+Math.ceil(h/s)+"</b>";var m=0;for(i=0;i<g.length;i++)m+=Math.pow(g[i]-f,2);a=a+"<br>"+O.standarddeviation+" : <b>"+Math.ceil(Math.sqrt(m/s))+"</b>"}}0==a.indexOf("<br>")&&(a=a.slice(4)),e.find(".qreport").html(a),e.find(".qreport").css("text-align","left"),ie()},H=function(){if(w("#predicate").length){var n=w(o);for(var e in questions){var t=questions[e];n.find(".questions").append('<option value="'+t.id+'">'+t.question.substr(0,120)+"</option>")}n.find(".questions").change(function(){!function(e,n){var t=questions[e],r=w("<ul></ul>");for(a in t.answers)answer=t.answers[a],r.append('<li><input style="margin:0" type="checkbox" value="'+answer.id+'"> '+answer.answer+"</input></li>");n.empty().append(r),n.closest(".criterionWrapper").find("ul input,select.oper").change(function(){G(w(this).closest(".criterionWrapper").children(".criterion"))})}(this.value,w(this).nextAll(".answers:first")),"one"==questions[this.value].type?w(this).next(".oper").children("[value='all']").remove():w(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>'),G(w(this).closest(".criterionWrapper").children(".criterion"))}),n.find(".questions *:selected").change(),n.find(".criterion").hover(function(){w(this).children(".criterionDelete").fadeIn(100)},function(){w(this).children(".criterionDelete").fadeOut(100)}),n.find(".criterionDelete").click(function(){w(this).hide(),w(this).closest(".criterionWrapper").slideUp(300,function(){w(this).remove(),ie()})}),n.on("DOMSubtreeModified",".boolOper",function(){var e=w(this).html();e==O.balance||e==O.aggregate?w(this).next().next().next().next().css("display","none"):w(this).next().next().next().next().css("display",""),e==O.balance&&(n.find(".questions").val(le()),n.find(".questions").change()),n.find(".qreport").html(""),G(w(this).closest(".criterionWrapper").children(".criterion"))}),w("#predicate").append(n),n.slideDown(300),n.find(".boolOper").html(""),n.find(".boolOper").html(O.aggregate)}},B=function(){q=[],w(".team").each(function(){var e=w(this),n=w(this).index(),t=[];e.find(".student").each(function(){var e=/student-(\d+)/.exec(w(this).attr("id"));t.push(e[1])}),q[n]=t}),1==A?w(".studentdel").hide():w(".studentdel").show()},D=function(){w("#unassigned").html(y),w("#teams").empty();for(var e=0;e<S.length;e++){var n=w('<div class="team" id="team-'+e+'" title ="'+S[e]+'" />');-1<w("#id_namingscheme").val().indexOf("$")?n.append("<h2 style='height:40px;'>"+S[e]+"</h2>"):n.append("<h2>"+S[e]+"</h2>"),n.width(x+20+10),n.append('<div class="sortable"></div>'),w("#teams").append(n)}var t={connectWith:".sortable",start:function(){I=!0},stop:function(e,n){B(),se(),U(),D()}};w("#teams .sortable").sortable(t),w("#unassigned .sortable").sortable(t);var r="",s=0;for(e in q){var a=questions;for(k in a){var i=a[k];for(var o in i.answers)a[k].answers[o].count=0}var l=q[e];n=w("#team-"+e+" > div.sortable");for(j in l){var c=l[j],u=w("#student-"+c),d=responses[c];if(d)for(k in questions){i=questions[k];for(m in nAggSpec=-1,i.answers)if(h=i.answers[m],-1!=w.inArray(parseInt(h.id),d))for(var p=0;p<_.length;p++)if(_[p][0]==O.aggregate&&_[p][2]==i.id&&void 0!==M[e]&&M[e][p]==a[k].answers[m].id){nAggSpec=a[k].answers[m].id;break}for(m in i.answers){var h=i.answers[m];-1!=w.inArray(parseInt(h.id),d)&&(-1!=nAggSpec?nAggSpec==a[k].answers[m].id&&a[k].answers[m].count++:a[k].answers[m].count++)}}u.detach(),n.append(u),-1!=w.inArray(c,T)?u.css("color","green"):u.css("color","")}if(0<q[0].length){var g=0;for(k in r=r+"<div id='sumbox_"+e+"' data-name={dataname_"+e+"} class='{sumbox_"+e+"} {avgbox_"+e+"} col-sm-4 col-md-3 border-rounded-right mylittlebox'><span style='font-weight:bold;'>"+S[e]+" ("+l.length+") </span><br>",a){i=a[k];for(o in failed=0,values=0,i.answers)color=re(a[k].answers[o],e),""!=color&&-1!=color.indexOf("red")&&(failed=1),""!=color&&values++,""!=color&&(r=r+a[k].question+" - "+a[k].answers[o].answer+" : <span style='"+color+"'>"+a[k].answers[o].count+"</span><br>"),""!=color&&-1!=color.indexOf("background-color:green")&&(r=(r=r.replace("{avgbox_"+e+"}",a[k].answers[o].answer.split(" ").join("_"))).replace("{dataname_"+e+"}",a[k].answers[o].answer.split(" ").join("_")));0==failed&&0<values?(g++,r=r+'<b><span style="color:green">'+a[k].question+" "+O.teamupsuccess+"</span></b><br>"):0<values?(g=-1e4,r=r+'<b><span style="color:red">'+a[k].question+" "+O.teamupwarning+"</span></b><br>"):g++}if(void 0!==C[e]){var f={id:-1};color=re(f,e),r=r+O.average+" :<span style='"+color+"'>"+C[e]+"</span><br>",-1!=color.indexOf("red")?(r=r+"<b><span style='color:red'>"+O.averagewarning+"</span></b><br>",g=0):(g++,r=r+"<b><span style='color:green'>"+O.averagesuccess+"</span></b><br>")}r+="</div>",r=0<g?(s++,r.replace("{sumbox_"+e+"}","box_ok")):r.replace("{sumbox_"+e+"}","box_ko")}}if(0<q.length&&0<q[0].length){var v;v=w(".student").length;var b=s/S.length*100;colSuccess="red",80<b&&(colSuccess="orange"),100==b&&(colSuccess="green"),r=(r=(r+='<div class="col-sm-4 col-md-3 border-rounded-right">')+O.nbGroupSuccess+' : <span style="color:'+colSuccess+';">'+s+"/"+S.length+"</span>")+"<br>"+O.nbStudent+" : "+v,r+="</div>",void 0!==C[e]?(r=r+'<div class="col-sm-4 col-md-3 border-rounded-right">'+O.average+" : "+L+"<br>"+O.standarddeviation+" :"+F+"<br>"+O.bornes+":"+(L-F/2).toFixed(2)+"-"+(L+F/2).toFixed(2)+"</div>",w("#feedback").html(O.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+S.length+"</span><br>"+O.nbStudent+" : "+v+"<br>"+O.average+" : "+L+"<br>"+O.standarddeviation+" :"+F+"<br>"+O.bornes+":"+(L-F/2).toFixed(2)+"-"+(L+F/2).toFixed(2))):w("#feedback").html(O.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+S.length+"</span><br>"+O.nbStudent+" : "+v)}else w("#feedback").html("");1==A?w(".studentdel").hide():w(".studentdel").show(),w("#summary").empty(),w("#summary").append(r)},P=function(e){var n={};return n.question=w(e).children(".questions").find("*:selected").val(),n.answers=[],n.oper=w(e).children(".oper").find("*:selected").val(),n.boolOper=w(e).children(".boolOper").html(),w(e).children(".answers").find("input:checked").each(function(){n.answers.push(this.value)}),n},N=function(e){var n,t=0,r=0,s=_[i][1].split(",");for(C=[],F=d=L=0,n=se(),L=Math.round(d/n),j=0;j<q.length;j++)for(k=0;k<q[j].length;k++)for(l=0;l<s.length;l++)if(0<responses[q[j][k]].length&&-1!=responses[q[j][k]].indexOf(parseInt(s[l],10))){t+=Math.pow(parseInt(questions[_[i][2]].answers[parseInt(s[l],10)].answer,10)-L,2);break}for(F=Math.round(Math.sqrt(t/n)),j=0;j<q.length;j++)for(k=0;k<q[j].length;k++)if(C[j]>L+F/2)for(l=0;l<s.length;l++){if(0<responses[q[j][k]].length&&-1!=responses[q[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[_[i][2]].answers[parseInt(s[l],10)].answer,10)>L)if(0<(c=Q(i,j,0)).length){X(j,k,c);for(var a=r=C[j]=0;a<q[j].length;a++)for(var o=0;o<s.length;o++)if(0<responses[q[j][a]].length&&-1!=responses[q[j][a]].indexOf(parseInt(s[o],10))){C[j]+=parseInt(questions[_[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}C[j]=C[j]/r;for(a=r=C[c[1]]=0;a<q[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[q[c[1]][a]].length&&-1!=responses[q[c[1]][a]].indexOf(parseInt(s[o],10))){C[c[1]]+=parseInt(questions[_[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(C[c[1]]=C[c[1]]/r,C[j]<L+F/2){k=1e6;break}}}else if(C[j]<L-F/2)for(l=0;l<s.length;l++){var c;if(0<responses[q[j][k]].length&&-1!=responses[q[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[_[i][2]].answers[parseInt(s[l],10)].answer,10)<L)if(0<(c=Q(i,j,1)).length){for(X(j,k,c),a=r=C[j]=0;a<q[j].length;a++)for(o=0;o<s.length;o++)if(0<responses[q[j][a]].length&&-1!=responses[q[j][a]].indexOf(parseInt(s[o],10))){C[j]+=parseInt(questions[_[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}for(C[j]=C[j]/r,a=r=C[c[1]]=0;a<q[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[q[c[1]][a]].length&&-1!=responses[q[c[1]][a]].indexOf(parseInt(s[o],10))){C[c[1]]+=parseInt(questions[_[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(C[c[1]]=C[c[1]]/r,C[j]>L-F/2){k=1e6;break}}}},R=function(e){for(var n=0;n<q.length;n++){for(var t=_[i][1].split(","),r=0,s=0,a=0,o=0,l=0;l<t.length;l++){for(var c=a=0;c<q[n].length;c++)o=l,0<responses[q[n][c]].length&&-1!=responses[q[n][c]].indexOf(parseInt(t[l],10))&&a++;r<a&&(r=a,s=o)}void 0===M[n]&&(M[n]=[]),M[n][i]=parseInt(t[s],10);for(c=0;c<q[n].length;c++)if(0<responses[q[n][c]].length&&-1==responses[q[n][c]].indexOf(M[n][i])&&-1==f.indexOf(q[n][c])){var u=$(n,M[n][i].toString());0<u.length&&(X(n,c,u),f.push(q[n][c]))}else 0<responses[q[n][c]].length&&-1!=responses[q[n][c]].indexOf(parseInt(t[s],10))&&f.push(q[n][c]);if(1==e){var d=[];for(c=0;c<q[n].length;c++)if(0<responses[q[n][c]].length&&-1==responses[q[n][c]].indexOf(M[n][i])&&-1==f.indexOf(q[n][c])){for(var p=-1,h=0;h<t.length;h++)if(-1!=responses[q[n][c]].indexOf(parseInt(t[h],10))){p=parseInt(t[h],10);break}var g=Z(n,p);-1<g&&(q[g].push(q[n][c]),f.push(q[n][c]),d.splice(0,0,c))}for(c=0;c<d.length;c++)q[n].splice(d[c],1)}}},E=function(e){for(var t=0;t<q.length;t++){for(var n=_[i][1].split(","),r=0;r<q[t].length;r++)if(-1!=f.indexOf(q[t][r]))for(s=0;s<n.length;s++)if(0<responses[q[t][r]].length&&-1!=responses[q[t][r]].indexOf(parseInt(n[s],10))){n.splice(s,1);break}for(r=0;r<q[t].length;r++)if(-1==f.indexOf(q[t][r]))for(nLength=n.length-1,s=nLength;0<=s;s--)0<responses[q[t][r]].length&&-1!=responses[q[t][r]].indexOf(parseInt(n[s],10))&&(n.splice(s,1),f.push(q[t][r]));for(var s=0;s<n.length;s++){var a;if(0<(a=$(t,n[s])).length){for(r=0;r<q[t].length;r++)if(-1==f.indexOf(q[t][r])){X(t,r,a);break}}else if(1==v)if(0<(a=Y(t,n[s])).length)for(r=0;r<q[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===q[t][r])},0)){X(t,r,a);break}}}},K=function(e){for(var n,t=0;t<q.length;t++){n=-1;for(var r=nCount=0;r<q[t].length;r++)for(var s=_[i][1].split(","),a=0;a<s.length;a++)if(0<responses[q[t][r]].length&&-1<responses[q[t][r]].indexOf(parseInt(s[a],10))){nCount++,n=r,nCount<=2&&f.push(q[t][r]);break}if(1==nCount)if(1==e){var o=V(t,_[i][1]);if(-1<o)q[o].push(q[t][n]),f.push(q[t][n]),q[t].splice(n,1);else if(1==v)if(0<(l=Y(t,_[i][1])).length){for(r=0;r<q[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===q[t][r])},0)){X(t,r,l);break}}else f.pop();else f.pop()}else{var l;if(0<(l=$(t,_[i][1])).length){for(r=0;r<q[t].length;r++)if(-1==f.indexOf(q[t][r])){X(t,r,l);break}}else if(1==v)if(0<(l=Y(t,_[i][1])).length){for(r=0;r<q[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===q[t][r])},0)){X(t,r,l);break}}else f.pop();else f.pop()}}},J=function(){for(var e=w(".student").length,n=Math.ceil(e/q.length),t=0;t<q.length;t++)if(q[t].length>n){for(var r=[],s=q[t].length-1;n<=s;s--)for(var a=0;a<q.length;a++)if((q[a].length<n||a==q.length-1)&&a!=t){q[a].push(q[t][s]),r.push(s);break}for(s=0;s<r.length;s++)q[t].splice(r[s],1)}else if(q[t].length<n)for(r=[],s=q[t].length;s<n;s++)for(a=0;a<q.length;a++)if((q[a].length>n||a==q.length-1)&&a!=t){if(q[t].push(q[a][q[a].length-1]),q[a].splice(q[a].length-1,1),0==q[a].length)return D(),w("#nbteam").val(w("#nbteam").val()-1),W(w("#nbteam").val()),B(),void J();break}D()},X=function(e,n,t){var r=q[e][n];q[e][n]=t[0],q[t[1]][t[2]]=r,f.push(t[0])},U=function(){for(var e=[],t=0;t<q.length;t++){for(var n=[],r=0;r<q[t].length;r++)n[r]={},n[r].id=q[t][r],n[r].weight=f.reduce(function(e,n){return e+(n===q[t][r])},0);n.sort(function(e,n){return n.weight-e.weight}),e[t]=[];for(r=0;r<q[t].length;r++)q[t][r]=n[r].id,e[t][r]=n[r].weight}return e},$=function(e,n){for(var t=0;t<q.length;t++)if(t!=e)for(var r=0;r<q[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[q[t][r]].length&&-1<responses[q[t][r]].indexOf(parseInt(s[a],10))&&-1==f.indexOf(q[t][r]))return[q[t][r],t,r];return[]},Y=function(e,n){for(var t=0;t<q.length;t++)if(t!=e&&void 0!==M[0]&&M[t][b]==M[e][b])for(var r=0;r<q[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[q[t][r]].length&&-1<responses[q[t][r]].indexOf(parseInt(s[a],10))&&1==f.reduce(function(e,n){return e+(n===q[t][r])},0))return[q[t][r],t,r];return[]},V=function(e,n){for(var t=[],r=0;r<q.length;r++){if(t[r]=0,r!=e)for(var s=0;s<q[r].length;s++)for(var a=n.split(","),i=0;i<a.length;i++)0<responses[q[r][s]].length&&-1<responses[q[r][s]].indexOf(parseInt(a[i],10))&&t[r]++;if(1==t[r])return r}for(r=0;r<q.length;r++)if(0<t[r])return r;return-1},Z=function(e,n){for(var t=[],r=0;r<q.length;r++){for(var s=t[r]=0;s<q[r].length;s++)r!=e&&0<responses[q[r][s]].length&&-1<responses[q[r][s]].indexOf(n)&&t[r]++;if(2<t[r])return r}return-1},Q=function(e,n,t){for(var r=_[e][1].split(","),s=0;s<q.length;s++)for(var a=0;a<q[s].length;a++){if(C[s]<L&&0==t&&s!=n)for(var i=0;i<r.length;i++)if(0<responses[q[s][a]].length&&-1!=responses[q[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[_[e][2]].answers[parseInt(r[i],10)].answer,10)<L&&-1==f.indexOf(q[s][a]))return[q[s][a],s,a];if(1==v&&void 0!==M[0]&&M[n][b]==M[s][b]&&parseInt(questions[_[e][2]].answers[parseInt(r[i],10)].answer,10)<L&&1==f.reduce(function(e,n){return e+(n===q[s][a])},0))return[q[s][a],s,a]}if(C[s]>L&&1==t&&s!=n)for(i=0;i<r.length;i++)if(0<responses[q[s][a]].length&&-1!=responses[q[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[_[e][2]].answers[parseInt(r[i],10)].answer,10)>L&&-1==f.indexOf(q[s][a]))return[q[s][a],s,a];if(1==v&&void 0!==M[0]&&M[n][b]==M[s][b]&&parseInt(questions[_[e][2]].answers[parseInt(r[i],10)].answer,10)>L&&1==f.reduce(function(e,n){return e+(n===q[s][a])},0))return[q[s][a],s,a]}}return[]},ee=function(e,n){if(sr=responses[e],!1===sr)return!1;var t;for(var r in t=!(n.oper="any"),n.answers)if(ans=parseInt(n.answers[r]),-1!=w.inArray(ans,sr)){t=!0;break}return t},ne=function(){B();var n=[];for(w("#unassigned .student").each(function(){var e=/student-(\d+)/.exec(this.id);n.push(e[1])}),n=te(n);0<n.length;){var e=0,r=[];for(i=1;i<q.length;i++)t=q[i],lt=q[e],t.length<lt.length?(e=i,r=[]):t.length==lt.length&&r.push(i);for(r.push(e);randomTeam=Math.floor(Math.random()*r.length),randomTeam>=r.length;);q[r[randomTeam]].push(n.pop())}D()},te=function(e){var n=[],t=e.slice(0);for(i=t.length;0<i;i--)index=Math.floor(Math.random()*i),n.push(t[index]),t.splice(index,1);return n},re=function(e,n){for(var t=0;t<_.length;t++)switch(_[t][0]){case O.cluster:for(var r=_[t][1].split(","),s=0;s<r.length;s++)if(e.id==parseInt(r[s],10)){if(count=ae(t,n),2<=count)return"color:green;font-weight:bold;";if(1==count)return"color:red;font-weight:bold;"}break;case O.distribute:for(r=_[t][1].split(","),s=0;s<r.length;s++){if(e.id==parseInt(r[s],10)&&0<e.count)return"color:green;font-weight:bold;";if(e.id==parseInt(r[s],10)&&0==e.count)return"color:red;font-weight:bold;"}break;case O.aggregate:if(-1!=(","+_[t][1]+",").indexOf(","+e.id+",")&&void 0!==M[n]){if(e.id==M[n][t])return"background-color:green;color:white;font-weight:bold;font-size:14px;padding:3px;";if(e.id!=M[n][t]&&0==e.count)return"color:green;font-weight:bold;";if(e.id!=M[n][t]&&0<e.count)return"color:red;font-weight:bold;"}break;case O.balance:if(-1==e.id)return C[n]>=L-F/2&&C[n]<=L+F/2?"color:green;font-weight:bold;":"color:red;font-weight:bold;"}return""},se=function(){for(var e=0,n=0,t=[],r=0;r<_.length;r++)if(_[r][0]==O.balance){t=_[r][1].split(",");break}if(0!=t.length){C=[];for(var s=d=L=0;s<q.length;s++){for(var a=n=C[s]=0;a<q[s].length;a++)for(var i=0;i<t.length;i++)if(0<responses[q[s][a]].length&&-1!=responses[q[s][a]].indexOf(parseInt(t[i],10))){nAnswer=parseInt(questions[_[r][2]].answers[parseInt(t[i],10)].answer,10),d+=nAnswer,C[s]+=nAnswer,e++,n++;break}C[s]=C[s]/n}return L=d/e,e}},ae=function(e,n){for(var t=0,r=_[e][1].split(","),s=0;s<q[n].length;s++)for(var a=0;a<r.length;a++)0!=responses[q[n][s]]&&-1!=responses[q[n][s]].indexOf(parseInt(r[a],10))&&t++;return t},ie=function(){g=oe(),h?(w("#resetteams").prop("disabled",!1),w("#prettify").prop("disabled",!1),w("#equalize").prop("disabled",!1)):(w("#resetteams").prop("disabled",!0),w("#prettify").prop("disabled",!0),w("#equalize").prop("disabled",!0)),g?w("#buildteams").prop("disabled",!1):w("#buildteams").prop("disabled",!0),1<w("#series option").length&&w("#serie").hide()},oe=function(){var n=[],e=[];if(w("#predicate .criterionWrapper").each(function(){var e=P(w(this).children(".criterion"));e.rule=w(this).find(".boolOper").html(),n.push(e)}),0==n.length)return!0;for(var t in n){for(var r in criterion=n[t],(e=[])[0]=criterion.rule,e[1]="",e[2]=criterion.question,criterion.answers)e[1]=e[1]+criterion.answers[r]+",";if(0<e[1].length&&e[0]!=O.balance)return!0;if(e[0]==O.distribute)return!0;if(e[0]==O.aggregate)return!0;if(e[0]==O.balance){for(qa in questions[criterion.question].answers)if(0==w.isNumeric(questions[e[2]].answers[qa].answer))return!1;return!0}}return!1},le=function(){var e=-1;for(qa in questions){for(answer in questions[qa].answers)e=1==w.isNumeric(questions[qa].answers[answer].answer)?qa:-1;if(-1<e)return e}return e},ce=function(){var e=w("#aggList").val();""!=e?(w(".box_ok").hide(),w(".box_ko").hide(),w("."+e).show()):(w(".box_ok").show(),w(".box_ko").show()),w("#smnu1").removeClass("active"),w("#smnu2").removeClass("active"),w("#smnu1").addClass("active")},ue=function(e){var n,t,r=e.length;if(r)for(;--r;)n=e[t=Math.floor(Math.random()*(r+1))],e[t]=e[r],e[r]=n;return e},de=function(){w(".unanswered .studentdel").click()},pe=function(){w(".answered  .studentdel").click()};return{init:function(){n.get_strings([{key:"criterionquestion",component:"mod_teamup"},{key:"distribute",component:"mod_teamup"},{key:"aggregate",component:"mod_teamup"},{key:"cluster",component:"mod_teamup"},{key:"balance",component:"mod_teamup"},{key:"createteams",component:"mod_teamup"},{key:"analyzeclustercriterion",component:"mod_teamup"},{key:"analyzeclusterwarning",component:"mod_teamup"},{key:"analyzeclustersuccess",component:"mod_teamup"},{key:"analyzeaggregatewarning",component:"mod_teamup"},{key:"noanswer",component:"mod_teamup"},{key:"analyzedistributesuccess",component:"mod_teamup"},{key:"analyzedistributewarning",component:"mod_teamup"},{key:"analyzedistributecriterion",component:"mod_teamup"},{key:"analyzebalancewarning",component:"mod_teamup"},{key:"total",component:"mod_teamup"},{key:"average",component:"mod_teamup"},{key:"standarddeviation",component:"mod_teamup"},{key:"teamupsuccess",component:"mod_teamup"},{key:"teamupwarning",component:"mod_teamup"},{key:"averagesuccess",component:"mod_teamup"},{key:"averagewarning",component:"mod_teamup"},{key:"bornes",component:"mod_teamup"},{key:"teamupsuccessnbr",component:"mod_teamup"},{key:"distributelabel",component:"mod_teamup"},{key:"aggregatelabel",component:"mod_teamup"},{key:"clusterlabel",component:"mod_teamup"},{key:"balancelabel",component:"mod_teamup"},{key:"distributionmode",component:"mod_teamup"},{key:"question",component:"mod_teamup"},{key:"groupTitle",component:"mod_teamup"},{key:"nbGroupSuccess",component:"mod_teamup"},{key:"nbStudent",component:"mod_teamup"},{key:"analyzeaggregatewarningOK",component:"mod_teamup"},{key:"abc",component:"mod_teamup"}]).done(function(e){!function(e){O.criterionquestion=e[0],O.distribute=e[1],O.aggregate=e[2],O.cluster=e[3],O.balance=e[4],O.createteams=e[5],O.analyzeclustercriterion=e[6],O.analyzeclusterwarning=e[7],O.analyzeclustersuccess=e[8],O.analyzeaggregatewarning=e[9],O.noanswer=e[10],O.analyzedistributesuccess=e[11],O.analyzedistributewarning=e[12],O.analyzedistributecriterion=e[13],O.analyzebalancewarning=e[14],O.total=e[15],O.average=e[16],O.standarddeviation=e[17],O.teamupsuccess=e[18],O.teamupwarning=e[19],O.averagesuccess=e[20],O.averagewarning=e[21],O.bornes=e[22],O.teamupsuccessnbr=e[23],O.distributeLabel=e[24],O.aggregateLabel=e[25],O.clusterLabel=e[26],O.balanceLabel=e[27],O.distributionMode=e[28],O.question=e[29],O.groupTitle=e[30],O.nbGroupSuccess=e[31],O.nbStudent=e[32],O.analyzeaggregatewarningOK=e[33],O.serie=e[34],o='<div  style="position: relative;" class="criterionWrapper sortable">',o+='  <div class="criterion ui-corner-all">',o+='    <div class="boolOper" style="display:none;">'+O.distributionMode+"</div>",o+='    <div class="operator">'+O.distributionMode+' : <select onChange="$(this).parent().prev().html(this.value);" style="margin-top:4px;">',o+='      <option  value="'+O.aggregate+'">'+O.aggregateLabel+"</option>",o+='      <option  value="'+O.distribute+'">'+O.distributeLabel+"</option>",o+='      <option  value="'+O.cluster+'">'+O.clusterLabel+"</option>",o+='      <option  value="'+O.balance+'">'+O.balanceLabel+"</option>",o+="    </select></div>",o+='    <div class="criterionDelete"></div>',o+="    "+O.question+' : <select class="questions"></select>',o+='    <div class="answers"></div>',o+='    <div class="qreport"></div>',o+="  </div>",o+="</div>"}(e),w(".stepper").each(function(){w(this).html();var e="<span id='nbstudentsdsp'> / "+w(".student").length+"("+Math.ceil(w(".student").length/parseInt(w("#nbteam").val()))+")</span>",n=w("<input id='nbteam' type='number' min='1' style='width:60px;height:26px;margin-top:10px;margin-right:5px;' value='1'>"+e);w(this).empty(),w("#placeithere").append(n),w("#nbstudentsdsp").html(" / "+w(".student").length+"("+Math.ceil(w(".student").length/parseInt(w("#nbteam").val()))+")"),w("#btcreate").click(function(){w("#protectAll").modal("show");var e=w("#nbteam").val();setTimeout(function(){W(e),w("#protectAll").modal("hide")},250)})}),w("#id_namingscheme").change(function(){var e=w("#nbteam").val();W(e)}),w("#nbteam").change(function(){var e=w("#nbteam").val();W(e)}),w("legend").click(function(){w(this).nextAll("div").toggle(),w(this).hasClass("myHide")?w(this).attr("class","myShow"):w(this).attr("class","myHide")}),w(".student").each(function(){w(this).width()>x&&(x=w(this).width())}),w(".student").each(function(){w(this).width(x)}),w("#unassigned").on("click",".studentdel",function(e){if(!A){e.stopPropagation(),w(".studentResponse").remove();var n=/studentdel-(\d+)/.exec(w(this).attr("id"))[1];u[n]=students[n],responses[n]=[],delete students[n],w("#student-"+n).remove(),w("#nbstudentsdsp").html(" / "+w(".student").length+"("+Math.ceil(w(".student").length/parseInt(w("#nbteam").val()))+")"),y=w("#unassigned").html(),w(".criterionWrapper").each(function(){G(w(this).closest(".criterionWrapper").children(".criterion"))})}}),w("#unassigned, #teams").on("mouseup",".student",function(e){if(I)I=!1;else{var t=w('<div class="studentResponse ui-corner-all"></div>'),n=/student-(\d+)/.exec(w(this).attr("id")),r=responses[n[1]];if(r){var s=w('<table class="mod-teamup-table"></table>');for(var a in t.append(s),questions){var i=questions[a];for(var o in qr=[],i.answers){var l=i.answers[o];-1!=w.inArray(parseInt(l.id),r)&&qr.push(l.answer)}var c=w('<tr><th scope="row">'+i.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");s.append(c)}}else t.html(O.noanswer);w(document.body).append(t),t.css("left",e.pageX),t.css("top",e.pageY);var u,d=function(e){e.target!=t.get(0)&&(t.remove(),w(document).unbind("mousedown",d))};w(document).mousedown(d),w(document).mouseover(function(e){var n=w(e.target).closest(".studentResponse");e.target!=this&&(0==n.length||0<n.length&&t.get(0)!=n.get(0))?null==u&&(u=setTimeout(function(){t.remove()},500)):u&&clearTimeout(u)})}}),w("#teams").on("dblclick",".team > h2",function(e){var n=w(e.target),t=n.html(),r=w('<input type="text" value="'+t+'" />');function s(){var e=w("<h2>"+r.val()+"</h2>");e.width(r.width()),e.height(r.height()),r.replaceWith(e),S[e.parent().index()]=e.html()}r.css("font-size",n.css("font-size")),r.width(n.width()),r.height(n.height()),r.css("border-width","0px");var a=function(e){e.target!=r.get(0)&&(s(),w(document).unbind("mousedown",a))};w(document).mousedown(a),r.keypress(function(e){13==e.keyCode&&(s(),w(document).unbind("mousedown",a))}),n.replaceWith(r),r.focus(),r.select()}),w("#nbteam").change(function(){w("#nbstudentsdsp").html(" / "+w(".student").length+"("+Math.ceil(w(".student").length/parseInt(w("#nbteam").val()))+")"),w(".criterionWrapper").each(function(){G(w(this).closest(".criterionWrapper").children(".criterion"))})}),w("#series").change(function(){window.location.search=z("group",window.location.search)+"&group="+w("#series").val()}),y=w("#unassigned").html(),W(1),H(),w("#predicate").sortable(),ie(),s()})}}});