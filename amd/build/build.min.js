define(["jquery","jqueryui","core/str"],function(b,e,n){function d(){S=[],M=[],h=!(_=[]);for(var e=0;e<x.length;e++)x[e]=[];I=!1,P()}function r(e,n){var t=0;b("#nameofgroup").show(),1==e&&d(),I=!0,B(),S=[],f=[];var r=[];for(c in h=!0,b("#predicate .criterionWrapper").each(function(){var e=D(b(this).children(".criterion"));e.rule=b(this).find(".boolOper").html(),r.push(e)}),unassignedStudents={},assignedStudents={},b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),unassignedStudents[rslt[1]]=students[rslt[1]]}),b(".team .student").each(function(){rslt=/student-(\d+)/.exec(this.id),assignedStudents[rslt[1]]=students[rslt[1]]}),b.each(responses,function(e,n){!1===n&&(delete assignedStudents[e],delete unassignedStudents[e]),t++}),i=0,v=!(O=[]),r){for(a in criterion=r[c],strLine="-"+criterion.rule+":"+questions[criterion.question].question+"<br>value:",O[i]=[],O[i][0]=criterion.rule,O[i][1]="",O[i][2]=criterion.question,criterion.answers)answer=questions[criterion.question].answers[criterion.answers[a]],strLine=strLine+answer.answer+"("+criterion.answers[a]+"),",O[i][1]=O[i][1]+criterion.answers[a]+",";if(O[i][0]==A.distribute&&""==O[i][1])for(qa in questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",";if(O[i][0]==A.aggregate){for(qa in v=!0,F=i,O[i][1]="",b("#aggList").empty(),b("#aggList").append(b("<option>",{value:"",text:""})),questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",",b("#aggList").append(b("<option>",{value:questions[criterion.question].answers[qa].answer.split(" ").join("_"),text:questions[criterion.question].answers[qa].answer}));b("#aggList").css("display",""),b("#aggListTitle").css("display","")}if(O[i][0]==A.balance)for(qa in questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",";O[i][1]=O[i][1].replace(new RegExp("[,]*$"),""),i++,strLine=strLine.replace(new RegExp("[,]*$"),"")}for(nMaxStudent=Math.ceil(t/q.length),ne(),nbTime=parseInt(6-t/100,10),nbTime<1&&(nbTime=1),5<nbTime&&(nbTime=5),nPlay=0;nPlay<nbTime;nPlay++){for(i=0;i<O.length;i++)switch(O[i][0]){case A.cluster:K(n);break;case A.distribute:E(n);break;case A.aggregate:R(n);break;case A.balance:N(n)}if(U(),n){avgStudentGroup=parseInt(t/x.length);for(var s=0;s<10;s++){for(var o=0,u=0;u<x.length;u++)if(x[u].length>avgStudentGroup)for(k=x[u].length-1;0<=k;k--)if(1==v&&1==f.reduce(function(e,n){return e+(n===x[u][k])},0)){for(l=0;l<x.length;l++)if(x[l].length-x[u].length<-1&&_[l][F]==_[u][F]){x[l].push(x[u][k]),x[u].splice(k,1),k=-1e6,o++;break}}else if(-1==f.indexOf(x[u][k]))for(l=0;l<x.length;l++)if(x[l].length<avgStudentGroup){x[l].push(x[u][k]),x[u].splice(k,1),k=-1e6,o++;break}0==o&&(s=15),U()}for(i=0;i<O.length;i++)if(O[i][0]==A.balance){N(n);break}}f=[]}P(),W(b("#nbteam").val())}function s(){b("#addnewcriterion").on("click",H),b("#buildteams").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){r(!0,!1),ie(),b("#protectAll").modal("hide")},250)}),b("#resetteams").on("click",function(){d(),ie(),W(0),W(1),b("#nbteam").val(1)}),b("#replay").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){r(!1,!1),ie(),b("#protectAll").modal("hide")},250)}),b("#assignrandomly").on("click",function(){ne(),ie()}),b("#creategroups").on("click",function(){!function(){B();var e=b('<form action="'+window.location+'" method="POST"></form>');for(i=0;i<q.length;i++){var n=q[i],t=x[i],r=b('<input type="hidden" name="teamnames['+i+']" value="'+n+'" />');e.append(r);var s=b('<input type="hidden" name="teams['+i+']" value="'+t.join(",")+'" />');e.append(s)}var a=b('<input type="hidden" name="action" value="create-groups" />'),o=b('<input type="hidden" name="groupingName" value="'+b("#groupingName").val()+'" />'),l=b('<input type="hidden" name="groupingID" value="'+b("#groupingSelect").val()+'" />'),c=b('<input type="hidden" name="inheritGroupingName" value="'+(b("#inheritGroupingName").is(":checked")?1:0)+'" />'),u=b('<input type="hidden" name="nogrouping" value="'+(b("#nogrouping").is(":checked")?1:0)+'" />');e.append(a),e.append(o),e.append(l),e.append(c),e.append(u),b("#createGroupsForm").append(e),e.submit()}(),ie()}),b("#prettify").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){r(!1,!0),ie(),b("#protectAll").modal("hide")},250)}),b("#serie").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){!function(){var e="";b("#nameofgroup").hide();x=[];var n=[];d(),I=h=!0,b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),n.push(rslt[1])});var t=Math.ceil(n.length/q.length),r=0,s=0;for(x[0]=[],i=0;i<n.length;i++)x[r][s]=n[i],t<=++s&&r<q.length-1&&(x[++r]=[],s=0);for(i=0;i<q.length;i++)e=""+(i+1),q[i]=A.serie+" "+"00".substring(0,"00".length-e.length)+e;P()}(),ie(),b("#protectAll").modal("hide")},250)}),b("#dsp_sum_switch").on("click",function(e){b(".box_ok").toggle(),e.stopPropagation()}),b("#aggList").on("click",function(){ce()}),b("#equalize").on("click",function(){J()}),b("#deleteallred").on("click",function(){de()}),b("#keepallred").on("click",function(){pe()})}var w,y=85,x=[],q=[],S=[],T=0,I=!1,A={},o="",f=[],O=[],_=[],u=[],M=[],C=0,p=0,L=0,h=!1,g=!1,v=!1,F=-1,z=function(e,n){var t=n.split("?")[0],r=[],s=-1!==n.indexOf("?")?n.split("?")[1]:"";if(""!==s){for(var a=(r=s.split("&")).length-1;0<=a;a-=1)r[a].split("=")[0]===e&&r.splice(a,1);t=t+"?"+r.join("&")}return t},W=function(e){B();var n=["A-Team","Agent Carter","Agents of S.H.I.E.L.D.","Akatsuki","All-Star Squadron","Alpha Flight","Angel Investigations","Aqua Teen Hunger Force","Arabian Knights","Archer and Armstrong","Armorines","Arrancar","Arrow","Astro Boy","Astro City","Autobots","Avengers","Batman","Battletoads","Ben 10","Beware the Batman","Big Hero 6","Biker Mice from Mars","Bionic Six","Bionic Woman","Birds of Prey","Black Scorpion","Blood Syndicate","Blue Falcon","Champions","Chouseishin","Crystal Gems","Darkstars","Defenders","Dick Tracy","Digvbc","Doom Patrol","Drak Pack","Elementals","Espada 10","Excalibur","Experts of Justice","Fairy Tail Guild","Fantastic 4","Fantastic Force","Fantastic Four","Fearless Defenders","Femforce","Flash","Flash Gordon","Force Works","Forever People","Freedom Fighters","Freedom Force","Freedom Phalanx","Frenetic Five","Future Foundation","Galaxy Angel","Galaxy Trio","Gatchaman","Gatchaman Crowds","Generation X","Gen¹³","Gotei 13","Gotham","Green Lantern Corps","H.A.R.D.Corps","Harbingers","Hero Alliance","Hero Association","Heroes","Heroes for Hire","Inferior Five","Infinity Inc.","Inhumans","Invaders","JLA","Jake 2.0","Jedi","Jessica Jones","Jetman","Justice League","Justice Machine","Kekkaishi","Kickers Inc.","Kiss (band)","Knight Sabers","Lady Blackhawk","Extraordinary Gentlemen","Legends of Tomorrow","Legion of Superheroes","Libra","Lieutenant Marvels","Lois and Clark","Lone Ranger","Lone Ranger Rides Again","Magic Knight Rayearth","Manhattan Clan","Manimal","Marvel Family","Marvel Knights","S.H.I.E.L.D.","Masters of the Universe","Men in Black","Metal Men","Mighty Crusaders","Mighty Mouse","Misfits","Misfits of Science","Mutant X","Mystery Men","Neo-Knights","Nextwave","Nightman","Nova Corps","Omega Men","Overwatch","Planetary","Power Pack","Power Rangers","Preacher","Psi-Force","Ronin Warriors","Runaways","S.H.I.E.L.D.","SWAT Kats","Sailor Senshi","Sailor Senshi","Samurai Pizza Cats","Sarah Solano","Secret Avengers","Secret Six","Section 8","Sentinels of Magic","Seven Soldiers of Victory","Shadowpact","Shi'ar Imperial Guard","Shinigami","Sign Gene","SilverHawks","Sky High","Sora","Sovereign Seven","Spectral Knights","Speedracer","Spider-Friends","Squadron Supreme","Squadron of Justice","Stormwatch","Stormwatch","Straw Hat Pirates","Street Sharks","Suicide Squad","Super Friends","Super Power Friends","Super Sentai","Superboy","Superfriends","Supergirl","Superhuman Samurai","Superman","T.H.U.N.D.E.R. Agents","Team 7","Team Avatar","Team Zenith","Teen Force","Teen Titans","Teenage Mutant Ninja Turtles","Terrific Three","The Aquabats","The Atomics","The Authority","The Avengers","The Beetleborgs","The Care Bears","The Centurions","The DNAgents","The Elite","The End League","The Galaxy Rangers","The Greatest American Hero","The Herculoids","The Impossibles","The Incarnations","The Incredible Hulk","The Incredibles","The Justice Friends","The Legion of Net.Heroes","The Loonatics","The Mighty Ducks","The Mighty Heroes","The N Team","The New League of Heroes","The New Wave","The Order of the Phoenix","The Others","The Outsiders","The Powerpuff Girls","The Six Million Dollar Man","The Specials","The Spectacular Spider-man","The Spider’s Web","The Strangers","The Super Capers","The Super Globetrotters","The Tick","The Tomorrow People","ThunderCats","Thunderbolts","Time Squad","Tokyo Mew Mew","Toxic Crusaders","Turbo-Man","Ultimates","Ultraforce","Uncanny X-Men","Underdog","Underfist","VR Troopers","Watchmen","West Coast Avengers","Wetworks","Wild C.A.T.s","Wolverine and the X-Men","Wonder Woman","X-Factor","X-Force","X-Men","X-Men 2099","X-Statix","Yatterman","Young Allies","Young Avengers","Young Justice","Z Warriors"];if(-1<b("#id_namingscheme").val().indexOf("*")){x.length>e&&(x=x.slice(0,e)),q.length>e&&(q=q.slice(0,e));for(var t=0;t<e;t++){var r=b("#id_namingscheme").val(),s=r;if(-1<r.indexOf("#"))s=r.replace("#",t+1);else if(-1<r.indexOf("@")){for(var a="",i=t;a+=0<=(i-=26)?String.fromCharCode("A".charCodeAt(0)+0):String.fromCharCode("A".charCodeAt(0)+i+26),0<=i;);s=r.replace("@",a)}s=void 0===b("#sumbox_"+t).data("name")||-1<b("#sumbox_"+t).data("name").indexOf("dataname")?s.replace("*",""):s.replace("*",b("#sumbox_"+t).data("name")),q[t]=s}}else if(x.length>e&&(x=x.slice(0,e)),q.length>e)q=q.slice(0,e);else if(q.length<e){var o=[];for(t=0;t<n.length;t++)o[t]=t;for(o=ue(o),t=q.length-1;t<e;t++){if(-1<(r=""!=b("#id_namingscheme").val()?b("#id_namingscheme").val():A.groupTitle).indexOf("#"))s=r.replace("#",t+1);else if(-1<r.indexOf("@")){for(a="",i=t;a+=0<=(i-=26)?String.fromCharCode("A".charCodeAt(0)+0):String.fromCharCode("A".charCodeAt(0)+i+26),0<=i;);s=r.replace("@",a)}else s=-1<r.indexOf("$")?r.replace("$",n[o[t]]):r+(t+1);q[t]=s}}P()},G=function(e){var n=D(e),t=n.boolOper,r=b("#nbteam").val(),s=0,a="";switch(t){case A.cluster:for(var i in students)!1!==responses[i]&&ee(i,n)&&s++;a+=A.analyzeclustercriterion.replace("{nbstudent}",s).replace("{nbteam}",r),a+=s/r<2?A.analyzeclusterwarning:A.analyzeclustersuccess;break;case A.aggregate:var o=0;for(var i in students)!1!==responses[i]&&s++;for(var l in p=[],studAvgByTeam=Math.ceil(s/r),questions[n.question].answers)p.push(l);for(var c=0;c<p.length;c++){for(i in o=0,students)!1!==responses[i]&&-1!=responses[i].indexOf(parseInt(p[c]))&&o++;var u=o%studAvgByTeam,d=parseInt(o/studAvgByTeam);color="",0!=u?(color="red",a+=A.analyzeaggregatewarning.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",o).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u)):(color="green",a+=A.analyzeaggregatewarningOK.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",o).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u))}break;case A.distribute:for(i in students)!1!==responses[i]&&s++;p=[],p=n.answers;for(c=0;c<p.length;c++){for(i in s=0,students)!1!==responses[i]&&(n.answers=[p[c]],ee(i,n)&&s++);status=r<=s?A.analyzedistributesuccess.replace("{nbteam}",r):A.analyzedistributewarning.replace("{nbteam}",r),a+=A.analyzedistributecriterion.replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",s).replace("{status}",status)}break;case A.balance:a="";var p=[];for(l in questions[n.question].answers)p.push(l);n.answers=p;var h=0,g=[];for(i in students)if(aRes=responses[i],!1!==responses[i]&&ee(i,n)){for(s++,c=0;c<p.length&&-1===aRes.indexOf(parseInt(p[c],10));c++);if(h+=parseInt(questions[n.question].answers[p[c]].answer),g.push(parseInt(questions[n.question].answers[p[c]].answer)),0==b.isNumeric(questions[n.question].answers[p[c]].answer)){a=A.analyzebalancewarning,s=0;break}}if(""==a){var f=h/s;a=(a=a+"<br>"+A.total+" : <b>"+h+"</b>")+"<br>"+A.average+" : <b>"+Math.ceil(h/s)+"</b>";var m=0;for(i=0;i<g.length;i++)m+=Math.pow(g[i]-f,2);a=a+"<br>"+A.standarddeviation+" : <b>"+Math.ceil(Math.sqrt(m/s))+"</b>"}}0==a.indexOf("<br>")&&(a=a.slice(4)),e.find(".qreport").html(a),e.find(".qreport").css("text-align","left"),ie()},H=function(){if(b("#predicate").length){var n=b(o);for(var e in questions){var t=questions[e];n.find(".questions").append('<option value="'+t.id+'">'+t.question.substr(0,120)+"</option>")}n.find(".questions").change(function(){!function(e,n){var t=questions[e],r=b("<ul></ul>");for(a in t.answers)answer=t.answers[a],r.append('<li><input style="margin:0" type="checkbox" value="'+answer.id+'"> '+answer.answer+"</input></li>");n.empty().append(r),n.closest(".criterionWrapper").find("ul input,select.oper").change(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}(this.value,b(this).nextAll(".answers:first")),"one"==questions[this.value].type?b(this).next(".oper").children("[value='all']").remove():b(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>'),G(b(this).closest(".criterionWrapper").children(".criterion"))}),n.find(".questions *:selected").change(),n.find(".criterion").hover(function(){b(this).children(".criterionDelete").fadeIn(100)},function(){b(this).children(".criterionDelete").fadeOut(100)}),n.find(".criterionDelete").click(function(){b(this).hide(),b(this).closest(".criterionWrapper").slideUp(300,function(){b(this).remove(),ie()})}),n.on("DOMSubtreeModified",".boolOper",function(){var e=b(this).html();e==A.balance||e==A.aggregate?b(this).next().next().next().next().css("display","none"):b(this).next().next().next().next().css("display",""),e==A.balance&&(n.find(".questions").val(le()),n.find(".questions").change()),n.find(".qreport").html(""),G(b(this).closest(".criterionWrapper").children(".criterion"))}),b("#predicate").append(n),n.slideDown(300),n.find(".boolOper").html(""),n.find(".boolOper").html(A.aggregate)}},B=function(){x=[],b(".team").each(function(){var e=b(this),n=b(this).index(),t=[];e.find(".student").each(function(){var e=/student-(\d+)/.exec(b(this).attr("id"));t.push(e[1])}),x[n]=t}),1==I?b(".studentdel").hide():b(".studentdel").show()},P=function(){b("#unassigned").html(w),b("#teams").empty();for(var e=0;e<q.length;e++){var n=b('<div class="team" id="team-'+e+'" title ="'+q[e]+'" />');-1<b("#id_namingscheme").val().indexOf("$")?n.append("<h2 style='height:40px;'>"+q[e]+"</h2>"):n.append("<h2>"+q[e]+"</h2>"),n.width(y+20+10),n.append('<div class="sortable"></div>'),b("#teams").append(n)}var t={connectWith:".sortable",start:function(){T=!0},stop:function(e,n){B(),se(),U(),P()}};b("#teams .sortable").sortable(t),b("#unassigned .sortable").sortable(t);var r="",s=0;for(e in x){var a=questions;for(k in a){var i=a[k];for(var o in i.answers)a[k].answers[o].count=0}var l=x[e];n=b("#team-"+e+" > div.sortable");for(j in l){var c=l[j],u=b("#student-"+c),d=responses[c];if(d)for(k in questions){i=questions[k];for(m in nAggSpec=-1,i.answers)if(p=i.answers[m],-1!=b.inArray(parseInt(p.id),d))for(cmdIdx=0;cmdIdx<O.length;cmdIdx++)if(O[cmdIdx][0]==A.aggregate&&O[cmdIdx][2]==i.id&&void 0!==_[e]&&_[e][cmdIdx]==a[k].answers[m].id){nAggSpec=a[k].answers[m].id;break}for(m in i.answers){var p=i.answers[m];-1!=b.inArray(parseInt(p.id),d)&&(-1!=nAggSpec?nAggSpec==a[k].answers[m].id&&a[k].answers[m].count++:a[k].answers[m].count++)}}u.detach(),n.append(u),-1!=b.inArray(c,S)?u.css("color","green"):u.css("color","")}if(0<x[0].length){var h=0;for(k in r=r+"<div id='sumbox_"+e+"' data-name={dataname_"+e+"} class='{sumbox_"+e+"} {avgbox_"+e+"} col-sm-4 col-md-3 border-rounded-right mylittlebox'><span style='font-weight:bold;'>"+q[e]+" ("+l.length+") </span><br>",a){i=a[k];for(o in failed=0,values=0,i.answers)color=re(a[k].answers[o],e),""!=color&&-1!=color.indexOf("red")&&(failed=1),""!=color&&values++,""!=color&&(r=r+a[k].question+" - "+a[k].answers[o].answer+" : <span style='"+color+"'>"+a[k].answers[o].count+"</span><br>"),""!=color&&-1!=color.indexOf("background-color:green")&&(r=(r=r.replace("{avgbox_"+e+"}",a[k].answers[o].answer.split(" ").join("_"))).replace("{dataname_"+e+"}",a[k].answers[o].answer.split(" ").join("_")));0==failed&&0<values?(h++,r=r+'<b><span style="color:green">'+a[k].question+" "+A.teamupsuccess+"</span></b><br>"):0<values?(h=-1e4,r=r+'<b><span style="color:red">'+a[k].question+" "+A.teamupwarning+"</span></b><br>"):h++}if(void 0!==M[e]){var g={id:-1};color=re(g,e),r=r+A.average+" :<span style='"+color+"'>"+M[e]+"</span><br>",-1!=color.indexOf("red")?(r=r+"<b><span style='color:red'>"+A.averagewarning+"</span></b><br>",h=0):(h++,r=r+"<b><span style='color:green'>"+A.averagesuccess+"</span></b><br>")}r+="</div>",r=0<h?(s++,r.replace("{sumbox_"+e+"}","box_ok")):r.replace("{sumbox_"+e+"}","box_ko")}}if(0<x.length&&0<x[0].length){var f;f=b(".student").length;var v=s/q.length*100;colSuccess="red",80<v&&(colSuccess="orange"),100==v&&(colSuccess="green"),r=(r=(r+='<div class="col-sm-4 col-md-3 border-rounded-right">')+A.nbGroupSuccess+' : <span style="color:'+colSuccess+';">'+s+"/"+q.length+"</span>")+"<br>"+A.nbStudent+" : "+f,r+="</div>",void 0!==M[e]?(r=r+'<div class="col-sm-4 col-md-3 border-rounded-right">'+A.average+" : "+C+"<br>"+A.standarddeviation+" :"+L+"<br>"+A.bornes+":"+(C-L/2).toFixed(2)+"-"+(C+L/2).toFixed(2)+"</div>",b("#feedback").html(A.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+q.length+"</span><br>"+A.nbStudent+" : "+f+"<br>"+A.average+" : "+C+"<br>"+A.standarddeviation+" :"+L+"<br>"+A.bornes+":"+(C-L/2).toFixed(2)+"-"+(C+L/2).toFixed(2))):b("#feedback").html(A.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+q.length+"</span><br>"+A.nbStudent+" : "+f)}else b("#feedback").html("");1==I?b(".studentdel").hide():b(".studentdel").show(),b("#summary").empty(),b("#summary").append(r)},D=function(e){var n={};return n.question=b(e).children(".questions").find("*:selected").val(),n.answers=[],n.oper=b(e).children(".oper").find("*:selected").val(),n.boolOper=b(e).children(".boolOper").html(),b(e).children(".answers").find("input:checked").each(function(){n.answers.push(this.value)}),n},N=function(e){var n,t=0,r=0,s=O[i][1].split(",");for(M=[],L=p=C=0,n=se(),C=Math.round(p/n),j=0;j<x.length;j++)for(k=0;k<x[j].length;k++)for(l=0;l<s.length;l++)if(0<responses[x[j][k]].length&&-1!=responses[x[j][k]].indexOf(parseInt(s[l],10))){t+=Math.pow(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)-C,2);break}for(L=Math.round(Math.sqrt(t/n)),j=0;j<x.length;j++)for(k=0;k<x[j].length;k++)if(M[j]>C+L/2)for(l=0;l<s.length;l++){if(0<responses[x[j][k]].length&&-1!=responses[x[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)>C)if(0<(c=Q(i,j,0)).length){X(j,k,c);for(var a=r=M[j]=0;a<x[j].length;a++)for(var o=0;o<s.length;o++)if(0<responses[x[j][a]].length&&-1!=responses[x[j][a]].indexOf(parseInt(s[o],10))){M[j]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}M[j]=M[j]/r;for(a=r=M[c[1]]=0;a<x[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[x[c[1]][a]].length&&-1!=responses[x[c[1]][a]].indexOf(parseInt(s[o],10))){M[c[1]]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(M[c[1]]=M[c[1]]/r,M[j]<C+L/2){k=1e6;break}}}else if(M[j]<C-L/2)for(l=0;l<s.length;l++){var c;if(0<responses[x[j][k]].length&&-1!=responses[x[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)<C)if(0<(c=Q(i,j,1)).length){for(X(j,k,c),a=r=M[j]=0;a<x[j].length;a++)for(o=0;o<s.length;o++)if(0<responses[x[j][a]].length&&-1!=responses[x[j][a]].indexOf(parseInt(s[o],10))){M[j]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}for(M[j]=M[j]/r,a=r=M[c[1]]=0;a<x[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[x[c[1]][a]].length&&-1!=responses[x[c[1]][a]].indexOf(parseInt(s[o],10))){M[c[1]]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(M[c[1]]=M[c[1]]/r,M[j]>C-L/2){k=1e6;break}}}},R=function(e){for(var n=0;n<x.length;n++){for(var t=O[i][1].split(","),r=0,s=0,a=0,o=0,l=0;l<t.length;l++){for(var c=a=0;c<x[n].length;c++)o=l,0<responses[x[n][c]].length&&-1!=responses[x[n][c]].indexOf(parseInt(t[l],10))&&a++;r<a&&(r=a,s=o)}void 0===_[n]&&(_[n]=[]),_[n][i]=parseInt(t[s],10);for(c=0;c<x[n].length;c++)if(0<responses[x[n][c]].length&&-1==responses[x[n][c]].indexOf(_[n][i])&&-1==f.indexOf(x[n][c])){var u=$(n,_[n][i].toString());0<u.length&&(X(n,c,u),f.push(x[n][c]))}else 0<responses[x[n][c]].length&&-1!=responses[x[n][c]].indexOf(parseInt(t[s],10))&&f.push(x[n][c]);if(1==e){var d=[];for(c=0;c<x[n].length;c++)if(0<responses[x[n][c]].length&&-1==responses[x[n][c]].indexOf(_[n][i])&&-1==f.indexOf(x[n][c])){for(var p=-1,h=0;h<t.length;h++)if(-1!=responses[x[n][c]].indexOf(parseInt(t[h],10))){p=parseInt(t[h],10);break}var g=Z(n,p);-1<g&&(x[g].push(x[n][c]),f.push(x[n][c]),d.splice(0,0,c))}for(c=0;c<d.length;c++)x[n].splice(d[c],1)}}},E=function(e){for(var t=0;t<x.length;t++){for(var n=O[i][1].split(","),r=0;r<x[t].length;r++)if(-1!=f.indexOf(x[t][r]))for(s=0;s<n.length;s++)if(0<responses[x[t][r]].length&&-1!=responses[x[t][r]].indexOf(parseInt(n[s],10))){n.splice(s,1);break}for(r=0;r<x[t].length;r++)if(-1==f.indexOf(x[t][r]))for(nLength=n.length-1,s=nLength;0<=s;s--)0<responses[x[t][r]].length&&-1!=responses[x[t][r]].indexOf(parseInt(n[s],10))&&(n.splice(s,1),f.push(x[t][r]));for(var s=0;s<n.length;s++){var a;if(0<(a=$(t,n[s])).length){for(r=0;r<x[t].length;r++)if(-1==f.indexOf(x[t][r])){X(t,r,a);break}}else if(1==v)if(0<(a=Y(t,n[s])).length)for(r=0;r<x[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===x[t][r])},0)){X(t,r,a);break}}}},K=function(e){for(var n,t=0;t<x.length;t++){n=-1;for(var r=nCount=0;r<x[t].length;r++)for(var s=O[i][1].split(","),a=0;a<s.length;a++)if(0<responses[x[t][r]].length&&-1<responses[x[t][r]].indexOf(parseInt(s[a],10))){nCount++,n=r,nCount<=2&&f.push(x[t][r]);break}if(1==nCount)if(1==e){var o=V(t,O[i][1]);if(-1<o)x[o].push(x[t][n]),f.push(x[t][n]),x[t].splice(n,1);else if(1==v)if(0<(l=Y(t,O[i][1])).length){for(r=0;r<x[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===x[t][r])},0)){X(t,r,l);break}}else f.pop();else f.pop()}else{var l;if(0<(l=$(t,O[i][1])).length){for(r=0;r<x[t].length;r++)if(-1==f.indexOf(x[t][r])){X(t,r,l);break}}else if(1==v)if(0<(l=Y(t,O[i][1])).length){for(r=0;r<x[t].length;r++)if(1==f.reduce(function(e,n){return e+(n===x[t][r])},0)){X(t,r,l);break}}else f.pop();else f.pop()}}},J=function(){for(var e=b(".student").length,n=Math.ceil(e/x.length),t=0;t<x.length;t++)if(x[t].length>n){for(var r=[],s=x[t].length-1;n<=s;s--)for(var a=0;a<x.length;a++)if((x[a].length<n||a==x.length-1)&&a!=t){x[a].push(x[t][s]),r.push(s);break}for(s=0;s<r.length;s++)x[t].splice(r[s],1)}else if(x[t].length<n)for(r=[],s=x[t].length;s<n;s++)for(a=0;a<x.length;a++)if((x[a].length>n||a==x.length-1)&&a!=t){if(x[t].push(x[a][x[a].length-1]),x[a].splice(x[a].length-1,1),0==x[a].length)return P(),b("#nbteam").val(b("#nbteam").val()-1),W(b("#nbteam").val()),B(),void J();break}P()},X=function(e,n,t){var r=x[e][n];x[e][n]=t[0],x[t[1]][t[2]]=r,f.push(t[0])},U=function(){for(var e=[],t=0;t<x.length;t++){for(var n=[],r=0;r<x[t].length;r++)n[r]={},n[r].id=x[t][r],n[r].weight=f.reduce(function(e,n){return e+(n===x[t][r])},0);n.sort(function(e,n){return n.weight-e.weight}),e[t]=[];for(r=0;r<x[t].length;r++)x[t][r]=n[r].id,e[t][r]=n[r].weight}return e},$=function(e,n){for(var t=0;t<x.length;t++)if(t!=e)for(var r=0;r<x[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[x[t][r]].length&&-1<responses[x[t][r]].indexOf(parseInt(s[a],10))&&-1==f.indexOf(x[t][r]))return[x[t][r],t,r];return[]},Y=function(e,n){for(var t=0;t<x.length;t++)if(t!=e&&void 0!==_[0]&&_[t][F]==_[e][F])for(var r=0;r<x[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[x[t][r]].length&&-1<responses[x[t][r]].indexOf(parseInt(s[a],10))&&1==f.reduce(function(e,n){return e+(n===x[t][r])},0))return[x[t][r],t,r];return[]},V=function(e,n){for(var t=[],r=0;r<x.length;r++){if(t[r]=0,r!=e)for(var s=0;s<x[r].length;s++)for(var a=n.split(","),i=0;i<a.length;i++)0<responses[x[r][s]].length&&-1<responses[x[r][s]].indexOf(parseInt(a[i],10))&&t[r]++;if(1==t[r])return r}for(r=0;r<x.length;r++)if(0<t[r])return r;return-1},Z=function(e,n){for(var t=[],r=0;r<x.length;r++){for(var s=t[r]=0;s<x[r].length;s++)r!=e&&0<responses[x[r][s]].length&&-1<responses[x[r][s]].indexOf(n)&&t[r]++;if(2<t[r])return r}return-1},Q=function(e,n,t){for(var r=O[e][1].split(","),s=0;s<x.length;s++)for(var a=0;a<x[s].length;a++){if(M[s]<C&&0==t&&s!=n)for(var i=0;i<r.length;i++)if(0<responses[x[s][a]].length&&-1!=responses[x[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)<C&&-1==f.indexOf(x[s][a]))return[x[s][a],s,a];if(1==v&&void 0!==_[0]&&_[n][F]==_[s][F]&&parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)<C&&1==f.reduce(function(e,n){return e+(n===x[s][a])},0))return[x[s][a],s,a]}if(M[s]>C&&1==t&&s!=n)for(i=0;i<r.length;i++)if(0<responses[x[s][a]].length&&-1!=responses[x[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)>C&&-1==f.indexOf(x[s][a]))return[x[s][a],s,a];if(1==v&&void 0!==_[0]&&_[n][F]==_[s][F]&&parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)>C&&1==f.reduce(function(e,n){return e+(n===x[s][a])},0))return[x[s][a],s,a]}}return[]},ee=function(e,n){if(sr=responses[e],!1===sr)return!1;var t;for(var r in t=!(n.oper="any"),n.answers)if(ans=parseInt(n.answers[r]),-1!=b.inArray(ans,sr)){t=!0;break}return t},ne=function(){B();var e=[];for(b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),e.push(rslt[1])}),e=te(e);0<e.length;){var n=0,r=[];for(i=1;i<x.length;i++)t=x[i],lt=x[n],t.length<lt.length?(n=i,r=[]):t.length==lt.length&&r.push(i);for(r.push(n);randomTeam=Math.floor(Math.random()*r.length),randomTeam>=r.length;);x[r[randomTeam]].push(e.pop())}P()},te=function(e){var n=[],t=e.slice(0);for(i=t.length;0<i;i--)index=Math.floor(Math.random()*i),n.push(t[index]),t.splice(index,1);return n},re=function(e,n){for(var t=0;t<O.length;t++)switch(O[t][0]){case A.cluster:for(var r=O[t][1].split(","),s=0;s<r.length;s++)if(e.id==parseInt(r[s],10)){if(count=ae(t,n),2<=count)return"color:green;font-weight:bold;";if(1==count)return"color:red;font-weight:bold;"}break;case A.distribute:for(r=O[t][1].split(","),s=0;s<r.length;s++){if(e.id==parseInt(r[s],10)&&0<e.count)return"color:green;font-weight:bold;";if(e.id==parseInt(r[s],10)&&0==e.count)return"color:red;font-weight:bold;"}break;case A.aggregate:if(-1!=(","+O[t][1]+",").indexOf(","+e.id+",")&&void 0!==_[n]){if(e.id==_[n][t])return"background-color:green;color:white;font-weight:bold;font-size:14px;padding:3px;";if(e.id!=_[n][t]&&0==e.count)return"color:green;font-weight:bold;";if(e.id!=_[n][t]&&0<e.count)return"color:red;font-weight:bold;"}break;case A.balance:if(-1==e.id)return M[n]>=C-L/2&&M[n]<=C+L/2?"color:green;font-weight:bold;":"color:red;font-weight:bold;"}return""},se=function(){for(var e=0,n=0,t=[],r=0;r<O.length;r++)if(O[r][0]==A.balance){t=O[r][1].split(",");break}if(0!=t.length){M=[];for(var s=p=C=0;s<x.length;s++){for(var a=n=M[s]=0;a<x[s].length;a++)for(var i=0;i<t.length;i++)if(0<responses[x[s][a]].length&&-1!=responses[x[s][a]].indexOf(parseInt(t[i],10))){nAnswer=parseInt(questions[O[r][2]].answers[parseInt(t[i],10)].answer,10),p+=nAnswer,M[s]+=nAnswer,e++,n++;break}M[s]=M[s]/n}return C=p/e,e}},ae=function(e,n){for(var t=0,r=O[e][1].split(","),s=0;s<x[n].length;s++)for(var a=0;a<r.length;a++)0!=responses[x[n][s]]&&-1!=responses[x[n][s]].indexOf(parseInt(r[a],10))&&t++;return t},ie=function(){g=oe(),h?(b("#resetteams").prop("disabled",!1),b("#prettify").prop("disabled",!1),b("#equalize").prop("disabled",!1)):(b("#resetteams").prop("disabled",!0),b("#prettify").prop("disabled",!0),b("#equalize").prop("disabled",!0)),g?b("#buildteams").prop("disabled",!1):b("#buildteams").prop("disabled",!0),1<b("#series option").length&&b("#serie").hide()},oe=function(){var n=[],e=[];if(b("#predicate .criterionWrapper").each(function(){var e=D(b(this).children(".criterion"));e.rule=b(this).find(".boolOper").html(),n.push(e)}),0==n.length)return!0;for(var t in n){for(var r in criterion=n[t],(e=[])[0]=criterion.rule,e[1]="",e[2]=criterion.question,criterion.answers)e[1]=e[1]+criterion.answers[r]+",";if(0<e[1].length&&e[0]!=A.balance)return!0;if(e[0]==A.distribute)return!0;if(e[0]==A.aggregate)return!0;if(e[0]==A.balance){for(qa in questions[criterion.question].answers)if(0==b.isNumeric(questions[e[2]].answers[qa].answer))return!1;return!0}}return!1},le=function(){var e=-1;for(qa in questions){for(answer in questions[qa].answers)e=1==b.isNumeric(questions[qa].answers[answer].answer)?qa:-1;if(-1<e)return e}return e},ce=function(){var e=b("#aggList").val();""!=e?(b(".box_ok").hide(),b(".box_ko").hide(),b("."+e).show()):(b(".box_ok").show(),b(".box_ko").show()),b("#smnu1").removeClass("active"),b("#smnu2").removeClass("active"),b("#smnu1").addClass("active")},ue=function(e){var n,t,r=e.length;if(r)for(;--r;)n=e[t=Math.floor(Math.random()*(r+1))],e[t]=e[r],e[r]=n;return e},de=function(){b(".unanswered .studentdel").click()},pe=function(){b(".answered  .studentdel").click()};return{init:function(){n.get_strings([{key:"criterionquestion",component:"mod_teamup"},{key:"distribute",component:"mod_teamup"},{key:"aggregate",component:"mod_teamup"},{key:"cluster",component:"mod_teamup"},{key:"balance",component:"mod_teamup"},{key:"createteams",component:"mod_teamup"},{key:"analyzeclustercriterion",component:"mod_teamup"},{key:"analyzeclusterwarning",component:"mod_teamup"},{key:"analyzeclustersuccess",component:"mod_teamup"},{key:"analyzeaggregatewarning",component:"mod_teamup"},{key:"noanswer",component:"mod_teamup"},{key:"analyzedistributesuccess",component:"mod_teamup"},{key:"analyzedistributewarning",component:"mod_teamup"},{key:"analyzedistributecriterion",component:"mod_teamup"},{key:"analyzebalancewarning",component:"mod_teamup"},{key:"total",component:"mod_teamup"},{key:"average",component:"mod_teamup"},{key:"standarddeviation",component:"mod_teamup"},{key:"teamupsuccess",component:"mod_teamup"},{key:"teamupwarning",component:"mod_teamup"},{key:"averagesuccess",component:"mod_teamup"},{key:"averagewarning",component:"mod_teamup"},{key:"bornes",component:"mod_teamup"},{key:"teamupsuccessnbr",component:"mod_teamup"},{key:"distributelabel",component:"mod_teamup"},{key:"aggregatelabel",component:"mod_teamup"},{key:"clusterlabel",component:"mod_teamup"},{key:"balancelabel",component:"mod_teamup"},{key:"distributionmode",component:"mod_teamup"},{key:"question",component:"mod_teamup"},{key:"groupTitle",component:"mod_teamup"},{key:"nbGroupSuccess",component:"mod_teamup"},{key:"nbStudent",component:"mod_teamup"},{key:"analyzeaggregatewarningOK",component:"mod_teamup"},{key:"abc",component:"mod_teamup"}]).done(function(e){!function(e){A.criterionquestion=e[0],A.distribute=e[1],A.aggregate=e[2],A.cluster=e[3],A.balance=e[4],A.createteams=e[5],A.analyzeclustercriterion=e[6],A.analyzeclusterwarning=e[7],A.analyzeclustersuccess=e[8],A.analyzeaggregatewarning=e[9],A.noanswer=e[10],A.analyzedistributesuccess=e[11],A.analyzedistributewarning=e[12],A.analyzedistributecriterion=e[13],A.analyzebalancewarning=e[14],A.total=e[15],A.average=e[16],A.standarddeviation=e[17],A.teamupsuccess=e[18],A.teamupwarning=e[19],A.averagesuccess=e[20],A.averagewarning=e[21],A.bornes=e[22],A.teamupsuccessnbr=e[23],A.distributeLabel=e[24],A.aggregateLabel=e[25],A.clusterLabel=e[26],A.balanceLabel=e[27],A.distributionMode=e[28],A.question=e[29],A.groupTitle=e[30],A.nbGroupSuccess=e[31],A.nbStudent=e[32],A.analyzeaggregatewarningOK=e[33],A.serie=e[34],o='<div  style="position: relative;" class="criterionWrapper sortable">',o+='  <div class="criterion ui-corner-all">',o+='    <div class="boolOper" style="display:none;">'+A.distributionMode+"</div>",o+='    <div class="operator">'+A.distributionMode+' : <select onChange="$(this).parent().prev().html(this.value);" style="margin-top:4px;">',o+='      <option  value="'+A.aggregate+'">'+A.aggregateLabel+"</option>",o+='      <option  value="'+A.distribute+'">'+A.distributeLabel+"</option>",o+='      <option  value="'+A.cluster+'">'+A.clusterLabel+"</option>",o+='      <option  value="'+A.balance+'">'+A.balanceLabel+"</option>",o+="    </select></div>",o+='    <div class="criterionDelete"></div>',o+="    "+A.question+' : <select class="questions"></select>',o+='    <div class="answers"></div>',o+='    <div class="qreport"></div>',o+="  </div>",o+="</div>"}(e),b(".stepper").each(function(){b(this).html();var e="<span id='nbstudentsdsp'> / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")</span>",n=b("<input id='nbteam' type='number' min='1' style='width:60px;height:26px;margin-top:10px;margin-right:5px;' value='1'>"+e);b(this).empty(),b("#placeithere").append(n),b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),b("#btcreate").click(function(){b("#protectAll").modal("show");var e=b("#nbteam").val();setTimeout(function(){W(e),b("#protectAll").modal("hide")},250)})}),b("#id_namingscheme").change(function(){var e=b("#nbteam").val();W(e)}),b("#nbteam").change(function(){var e=b("#nbteam").val();W(e)}),b("legend").click(function(){b(this).nextAll("div").toggle(),b(this).hasClass("myHide")?b(this).attr("class","myShow"):b(this).attr("class","myHide")}),b(".student").each(function(){b(this).width()>y&&(y=b(this).width())}),b(".student").each(function(){b(this).width(y)}),b("#unassigned").on("click",".studentdel",function(e){if(!I){e.stopPropagation(),b(".studentResponse").remove();var n=/studentdel-(\d+)/.exec(b(this).attr("id"))[1];u[n]=students[n],responses[n]=[],delete students[n],b("#student-"+n).remove(),b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),w=b("#unassigned").html(),b(".criterionWrapper").each(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}}),b("#unassigned, #teams").on("mouseup",".student",function(e){if(T)T=!1;else{var t=b('<div class="studentResponse ui-corner-all"></div>'),n=/student-(\d+)/.exec(b(this).attr("id")),r=responses[n[1]];if(r){var s=b('<table class="mod-teamup-table"></table>');for(var a in t.append(s),questions){var i=questions[a];for(var o in qr=[],i.answers){var l=i.answers[o];-1!=b.inArray(parseInt(l.id),r)&&qr.push(l.answer)}var c=b('<tr><th scope="row">'+i.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");s.append(c)}}else t.html(A.noanswer);b(document.body).append(t),t.css("left",e.pageX),t.css("top",e.pageY);var u,d=function(e){e.target!=t.get(0)&&(t.remove(),b(document).unbind("mousedown",d))};b(document).mousedown(d),b(document).mouseover(function(e){var n=b(e.target).closest(".studentResponse");e.target!=this&&(0==n.length||0<n.length&&t.get(0)!=n.get(0))?null==u&&(u=setTimeout(function(){t.remove()},500)):u&&clearTimeout(u)})}}),b("#teams").on("dblclick",".team > h2",function(e){var n=b(e.target),t=n.html(),r=b('<input type="text" value="'+t+'" />');function s(){var e=b("<h2>"+r.val()+"</h2>");e.width(r.width()),e.height(r.height()),r.replaceWith(e),q[e.parent().index()]=e.html()}r.css("font-size",n.css("font-size")),r.width(n.width()),r.height(n.height()),r.css("border-width","0px");var a=function(e){e.target!=r.get(0)&&(s(),b(document).unbind("mousedown",a))};b(document).mousedown(a),r.keypress(function(e){13==e.keyCode&&(s(),b(document).unbind("mousedown",a))}),n.replaceWith(r),r.focus(),r.select()}),b("#nbteam").change(function(){b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),b(".criterionWrapper").each(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}),b("#series").change(function(){window.location.search=z("group",window.location.search)+"&group="+b("#series").val()}),w=b("#unassigned").html(),W(1),H(),b("#predicate").sortable(),ie(),s()})}}});