define(["jquery","jqueryui","core/str"],function(b,e,s){var f,v=85,w=[],y=[],x=[],T=[],S=0,I=!1,A={},r="",h=[],O=[],_=[],o=[],M=[],C=0,u=0,F=0,d=!1,n=!1,p=!1,g=-1,N=function(e,n){var t=n.split("?")[0],r=[],s=-1!==n.indexOf("?")?n.split("?")[1]:"";if(""!==s){for(var a=(r=s.split("&")).length-1;0<=a;a-=1)r[a].split("=")[0]===e&&r.splice(a,1);t=t+"?"+r.join("&")}return t},L=function(e){B();var n=["A-Team","Agent Carter","Agents of S.H.I.E.L.D.","Akatsuki","All-Star Squadron","Alpha Flight","Angel Investigations","Aqua Teen Hunger Force","Arabian Knights","Archer and Armstrong","Armorines","Arrancar","Arrow","Astro Boy","Astro City","Autobots","Avengers","Batman","Battletoads","Ben 10","Beware the Batman","Big Hero 6","Biker Mice from Mars","Bionic Six","Bionic Woman","Birds of Prey","Black Scorpion","Blood Syndicate","Blue Falcon","Champions","Chouseishin","Crystal Gems","Darkstars","Defenders","Dick Tracy","Digvbc","Doom Patrol","Drak Pack","Elementals","Espada 10","Excalibur","Experts of Justice","Fairy Tail Guild","Fantastic 4","Fantastic Force","Fantastic Four","Fearless Defenders","Femforce","Flash","Flash Gordon","Force Works","Forever People","Freedom Fighters","Freedom Force","Freedom Phalanx","Frenetic Five","Future Foundation","Galaxy Angel","Galaxy Trio","Gatchaman","Gatchaman Crowds","Generation X","Gen¹³","Gotei 13","Gotham","Green Lantern Corps","H.A.R.D.Corps","Harbingers","Hero Alliance","Hero Association","Heroes","Heroes for Hire","Inferior Five","Infinity Inc.","Inhumans","Invaders","JLA","Jake 2.0","Jedi","Jessica Jones","Jetman","Justice League","Justice Machine","Kekkaishi","Kickers Inc.","Kiss (band)","Knight Sabers","Lady Blackhawk","Extraordinary Gentlemen","Legends of Tomorrow","Legion of Superheroes","Libra","Lieutenant Marvels","Lois and Clark","Lone Ranger","Lone Ranger Rides Again","Magic Knight Rayearth","Manhattan Clan","Manimal","Marvel Family","Marvel Knights","S.H.I.E.L.D.","Masters of the Universe","Men in Black","Metal Men","Mighty Crusaders","Mighty Mouse","Misfits","Misfits of Science","Mutant X","Mystery Men","Neo-Knights","Nextwave","Nightman","Nova Corps","Omega Men","Overwatch","Planetary","Power Pack","Power Rangers","Preacher","Psi-Force","Ronin Warriors","Runaways","S.H.I.E.L.D.","SWAT Kats","Sailor Senshi","Sailor Senshi","Samurai Pizza Cats","Sarah Solano","Secret Avengers","Secret Six","Section 8","Sentinels of Magic","Seven Soldiers of Victory","Shadowpact","Shi'ar Imperial Guard","Shinigami","Sign Gene","SilverHawks","Sky High","Sora","Sovereign Seven","Spectral Knights","Speedracer","Spider-Friends","Squadron Supreme","Squadron of Justice","Stormwatch","Stormwatch","Straw Hat Pirates","Street Sharks","Suicide Squad","Super Friends","Super Power Friends","Super Sentai","Superboy","Superfriends","Supergirl","Superhuman Samurai","Superman","T.H.U.N.D.E.R. Agents","Team 7","Team Avatar","Team Zenith","Teen Force","Teen Titans","Teenage Mutant Ninja Turtles","Terrific Three","The Aquabats","The Atomics","The Authority","The Avengers","The Beetleborgs","The Care Bears","The Centurions","The DNAgents","The Elite","The End League","The Galaxy Rangers","The Greatest American Hero","The Herculoids","The Impossibles","The Incarnations","The Incredible Hulk","The Incredibles","The Justice Friends","The Legion of Net.Heroes","The Loonatics","The Mighty Ducks","The Mighty Heroes","The N Team","The New League of Heroes","The New Wave","The Order of the Phoenix","The Others","The Outsiders","The Powerpuff Girls","The Six Million Dollar Man","The Specials","The Spectacular Spider-man","The Spider’s Web","The Strangers","The Super Capers","The Super Globetrotters","The Tick","The Tomorrow People","ThunderCats","Thunderbolts","Time Squad","Tokyo Mew Mew","Toxic Crusaders","Turbo-Man","Ultimates","Ultraforce","Uncanny X-Men","Underdog","Underfist","VR Troopers","Watchmen","West Coast Avengers","Wetworks","Wild C.A.T.s","Wolverine and the X-Men","Wonder Woman","X-Factor","X-Force","X-Men","X-Men 2099","X-Statix","Yatterman","Young Allies","Young Avengers","Young Justice","Z Warriors"];if(-1<b("#id_namingscheme").val().indexOf("*")){w.length>e&&(w=w.slice(0,e)),x.length>e&&(x=x.slice(0,e));for(var t=0;t<e;t++){if(sTeamName=b("#id_namingscheme").val(),sFullTeamName=sTeamName,-1<sTeamName.indexOf("#"))sFullTeamName=sTeamName.replace("#",t+1);else if(-1<sTeamName.indexOf("@")){var r="";for(numChar=t;numChar-=26,0<=numChar?r+=String.fromCharCode("A".charCodeAt(0)+0):r+=String.fromCharCode("A".charCodeAt(0)+numChar+26),0<=numChar;);sFullTeamName=sTeamName.replace("@",r)}void 0===b("#sumbox_"+t).data("name")||-1<b("#sumbox_"+t).data("name").indexOf("dataname")?sFullTeamName=sFullTeamName.replace("*",""):sFullTeamName=sFullTeamName.replace("*",b("#sumbox_"+t).data("name")),x[t]=sFullTeamName}}else if(w.length>e&&(w=w.slice(0,e)),x.length>e)x=x.slice(0,e);else if(x.length<e){var s=[];for(t=0;t<n.length;t++)s[t]=t;for(s=he(s),t=x.length-1;t<e;t++){if(""!=b("#id_namingscheme").val()?sTeamName=b("#id_namingscheme").val():sTeamName=A.groupTitle,-1<sTeamName.indexOf("#"))sFullTeamName=sTeamName.replace("#",t+1);else if(-1<sTeamName.indexOf("@")){r="";for(numChar=t;numChar-=26,0<=numChar?r+=String.fromCharCode("A".charCodeAt(0)+0):r+=String.fromCharCode("A".charCodeAt(0)+numChar+26),0<=numChar;);sFullTeamName=sTeamName.replace("@",r)}else-1<sTeamName.indexOf("$")?sFullTeamName=sTeamName.replace("$",n[s[t]]):sFullTeamName=sTeamName+(t+1);x[t]=sFullTeamName}}P()},W=function(){T=[],M=[],d=!(_=[]);for(var e=0;e<w.length;e++)w[e]=[];I=!1,P()},G=function(e){var n=D(e),t=n.boolOper,r=b("#nbteam").val(),s=0,o="";switch(t){case A.cluster:for(i in students)!1!==responses[i]&&te(i,n)&&s++;o+=A.analyzeclustercriterion.replace("{nbstudent}",s).replace("{nbteam}",r),o+=s/r<2?A.analyzeclusterwarning:A.analyzeclustersuccess;break;case A.aggregate:var l=0;for(i in students)!1!==responses[i]&&s++;for(a in p=[],studAvgByTeam=Math.ceil(s/r),questions[n.question].answers)p.push(a);for(var c=0;c<p.length;c++){for(i in l=0,students)!1!==responses[i]&&-1!=responses[i].indexOf(parseInt(p[c]))&&l++;var u=l%studAvgByTeam,d=parseInt(l/studAvgByTeam);color="",0!=u?(color="red",o+=A.analyzeaggregatewarning.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",l).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u)):(color="green",o+=A.analyzeaggregatewarningOK.replace("{color}",color).replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",l).replace("{reste}",u).replace("{nbgroup}",d).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",u))}break;case A.distribute:for(i in students)!1!==responses[i]&&s++;p=[],p=n.answers;for(c=0;c<p.length;c++){for(i in s=0,students)!1!==responses[i]&&(n.answers=[p[c]],te(i,n)&&s++);status=r<=s?A.analyzedistributesuccess.replace("{nbteam}",r):A.analyzedistributewarning.replace("{nbteam}",r),o+=A.analyzedistributecriterion.replace("{answer}",questions[n.question].answers[p[c]].answer).replace("{nbstudent}",s).replace("{status}",status)}break;case A.balance:o="";var p=[];for(a in questions[n.question].answers)p.push(a);n.answers=p;var h=0,g=[];for(i in students)if(aRes=responses[i],!1!==responses[i]&&te(i,n)){for(s++,c=0;c<p.length&&-1===aRes.indexOf(parseInt(p[c],10));c++);if(h+=parseInt(questions[n.question].answers[p[c]].answer),g.push(parseInt(questions[n.question].answers[p[c]].answer)),0==b.isNumeric(questions[n.question].answers[p[c]].answer)){o=A.analyzebalancewarning,s=0;break}}if(""==o){var f=h/s;o=(o=o+"<br>"+A.total+" : <b>"+h+"</b>")+"<br>"+A.average+" : <b>"+Math.ceil(h/s)+"</b>";var m=0;for(i=0;i<g.length;i++)m+=Math.pow(g[i]-f,2);o=o+"<br>"+A.standarddeviation+" : <b>"+Math.ceil(Math.sqrt(m/s))+"</b>"}}0==o.indexOf("<br>")&&(o=o.slice(4)),e.find(".qreport").html(o),e.find(".qreport").css("text-align","left"),ce()},H=function(){if(b("#predicate").length){var n=b(r);for(var e in questions)q=questions[e],n.find(".questions").append('<option value="'+q.id+'">'+q.question.substr(0,120)+"</option>");n.find(".questions").change(function(){!function(e,n){q=questions[e];var t=b("<ul></ul>");for(a in q.answers)answer=q.answers[a],t.append('<li><input style="margin:0" type="checkbox" value="'+answer.id+'"> '+answer.answer+"</input></li>");n.empty().append(t),n.closest(".criterionWrapper").find("ul input,select.oper").change(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}(this.value,b(this).nextAll(".answers:first")),"one"==questions[this.value].type?b(this).next(".oper").children("[value='all']").remove():b(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>'),G(b(this).closest(".criterionWrapper").children(".criterion"))}),n.find(".questions *:selected").change(),n.find(".criterion").hover(function(){b(this).children(".criterionDelete").fadeIn(100)},function(){b(this).children(".criterionDelete").fadeOut(100)}),n.find(".criterionDelete").click(function(){b(this).hide(),b(this).closest(".criterionWrapper").slideUp(300,function(){b(this).remove(),ce()})}),n.on("DOMSubtreeModified",".boolOper",function(){var e=b(this).html();e==A.balance||e==A.aggregate?b(this).next().next().next().next().css("display","none"):b(this).next().next().next().next().css("display",""),e==A.balance&&(n.find(".questions").val(de()),n.find(".questions").change()),n.find(".qreport").html(""),G(b(this).closest(".criterionWrapper").children(".criterion"))}),b("#predicate").append(n),n.slideDown(300),n.find(".boolOper").html(""),n.find(".boolOper").html(A.aggregate)}},B=function(){w=[],b(".team").each(function(){var e=b(this),n=b(this).index(),t=[];e.find(".student").each(function(){var e=/student-(\d+)/.exec(b(this).attr("id"));t.push(e[1])}),w[n]=t}),1==I?b(".studentdel").hide():b(".studentdel").show()},P=function(){b("#unassigned").html(f),b("#teams").empty();for(var e=0;e<x.length;e++){var n=b('<div class="team" id="team-'+e+'" title ="'+x[e]+'" />');-1<b("#id_namingscheme").val().indexOf("$")?n.append("<h2 style='height:40px;'>"+x[e]+"</h2>"):n.append("<h2>"+x[e]+"</h2>"),n.width(v+20+10),n.append('<div class="sortable"></div>'),b("#teams").append(n)}var t={connectWith:".sortable",start:function(){S=!0},stop:function(e,n){B(),oe(),y=Y(),P()}};b("#teams .sortable").sortable(t),b("#unassigned .sortable").sortable(t);var r="",s=0;for(e in w){var i=questions;for(k in i)for(l in q=i[k],q.answers)i[k].answers[l].count=0;var o=w[e];n=b("#team-"+e+" > div.sortable");for(j in o){var c=o[j],u=b("#student-"+c),d=responses[c];if(d)for(k in questions){for(m in q=questions[k],nAggSpec=-1,q.answers)if(a=q.answers[m],-1!=b.inArray(parseInt(a.id),d))for(cmdIdx=0;cmdIdx<O.length;cmdIdx++)if(O[cmdIdx][0]==A.aggregate&&O[cmdIdx][2]==q.id&&void 0!==_[e]&&_[e][cmdIdx]==i[k].answers[m].id){nAggSpec=i[k].answers[m].id;break}for(m in q.answers)a=q.answers[m],-1!=b.inArray(parseInt(a.id),d)&&(-1!=nAggSpec?nAggSpec==i[k].answers[m].id&&i[k].answers[m].count++:i[k].answers[m].count++)}u.detach(),n.append(u),-1!=b.inArray(c,T)?u.css("color","green"):(u.css("color",""),y[e])}if(0<w[0].length){for(k in gpok=0,r=r+"<div id='sumbox_"+e+"' data-name={dataname_"+e+"} class='{sumbox_"+e+"} {avgbox_"+e+"} col-sm-4 col-md-3 border-rounded-right mylittlebox'><span style='font-weight:bold;'>"+x[e]+" ("+o.length+")</span><br>",i){for(l in q=i[k],failed=0,values=0,q.answers)color=ie(i[k].answers[l],e),""!=color&&-1!=color.indexOf("red")&&(failed=1),""!=color&&values++,""!=color&&(r=r+i[k].question+" - "+i[k].answers[l].answer+" : <span style='"+color+"'>"+i[k].answers[l].count+"</span><br>"),""!=color&&-1!=color.indexOf("background-color:green")&&(r=(r=r.replace("{avgbox_"+e+"}",i[k].answers[l].answer.split(" ").join("_"))).replace("{dataname_"+e+"}",i[k].answers[l].answer.split(" ").join("_")));0==failed&&0<values?(gpok++,r=r+'<b><span style="color:green">'+i[k].question+" "+A.teamupsuccess+"</span></b><br>"):0<values?(gpok=-1e4,r=r+'<b><span style="color:red">'+i[k].question+" "+A.teamupwarning+"</span></b><br>"):gpok++}if(void 0!==M[e]){var p={id:-1};color=ie(p,e),r=r+A.average+" :<span style='"+color+"'>"+M[e]+"</span><br>",-1!=color.indexOf("red")?(r=r+"<b><span style='color:red'>"+A.averagewarning+"</span></b><br>",gpok=0):(gpok++,r=r+"<b><span style='color:green'>"+A.averagesuccess+"</span></b><br>")}r+="</div>",r=0<gpok?(s++,r.replace("{sumbox_"+e+"}","box_ok")):r.replace("{sumbox_"+e+"}","box_ko")}}if(0<w.length&&0<w[0].length){var h;h=b(".student").length;var g=s/x.length*100;colSuccess="red",80<g&&(colSuccess="orange"),100==g&&(colSuccess="green"),r=(r=(r+='<div class="col-sm-4 col-md-3 border-rounded-right">')+A.nbGroupSuccess+' : <span style="color:'+colSuccess+';">'+s+"/"+x.length+"</span>")+"<br>"+A.nbStudent+" : "+h,r+="</div>",void 0!==M[e]?(r=r+'<div class="col-sm-4 col-md-3 border-rounded-right">'+A.average+" : "+C+"<br>"+A.standarddeviation+" :"+F+"<br>"+A.bornes+":"+(C-F/2).toFixed(2)+"-"+(C+F/2).toFixed(2)+"</div>",b("#feedback").html(A.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+x.length+"</span><br>"+A.nbStudent+" : "+h+"<br>"+A.average+" : "+C+"<br>"+A.standarddeviation+" :"+F+"<br>"+A.bornes+":"+(C-F/2).toFixed(2)+"-"+(C+F/2).toFixed(2))):b("#feedback").html(A.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+s+"/"+x.length+"</span><br>"+A.nbStudent+" : "+h)}else b("#feedback").html("");1==I?b(".studentdel").hide():b(".studentdel").show(),b("#summary").empty(),b("#summary").append(r)},D=function(e){var n={};return n.question=b(e).children(".questions").find("*:selected").val(),n.answers=[],n.oper=b(e).children(".oper").find("*:selected").val(),n.boolOper=b(e).children(".boolOper").html(),b(e).children(".answers").find("input:checked").each(function(){n.answers.push(this.value)}),n},R=function(e,n){var t=0;b("#nameofgroup").show(),1==e&&W(),I=!0,B(),T=[],h=[];var r=[];for(c in d=!0,b("#predicate .criterionWrapper").each(function(){var e=D(b(this).children(".criterion"));e.rule=b(this).find(".boolOper").html(),r.push(e)}),unassignedStudents={},assignedStudents={},b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),unassignedStudents[rslt[1]]=students[rslt[1]]}),b(".team .student").each(function(){rslt=/student-(\d+)/.exec(this.id),assignedStudents[rslt[1]]=students[rslt[1]]}),b.each(responses,function(e,n){!1===n&&(delete assignedStudents[e],delete unassignedStudents[e]),t++}),O=[],i=0,p=!1,r){for(a in criterion=r[c],strLine="-"+criterion.rule+":"+questions[criterion.question].question+"<br>value:",O[i]=[],O[i][0]=criterion.rule,O[i][1]="",O[i][2]=criterion.question,criterion.answers)answer=questions[criterion.question].answers[criterion.answers[a]],strLine=strLine+answer.answer+"("+criterion.answers[a]+"),",O[i][1]=O[i][1]+criterion.answers[a]+",";if(O[i][0]==A.distribute&&""==O[i][1])for(qa in questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",";if(O[i][0]==A.aggregate){for(qa in p=!0,g=i,O[i][1]="",b("#aggList").empty(),b("#aggList").append(b("<option>",{value:"",text:""})),questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",",b("#aggList").append(b("<option>",{value:questions[criterion.question].answers[qa].answer.split(" ").join("_"),text:questions[criterion.question].answers[qa].answer}));b("#aggList").css("display",""),b("#aggListTitle").css("display","")}if(O[i][0]==A.balance)for(qa in questions[criterion.question].answers)O[i][1]=O[i][1]+qa+",";O[i][1]=O[i][1].replace(new RegExp("[,]*$"),""),i++,strLine=strLine.replace(new RegExp("[,]*$"),"")}for(nMaxStudent=Math.ceil(t/x.length),re(),nbTime=parseInt(6-t/100,10),nbTime<1&&(nbTime=1),5<nbTime&&(nbTime=5),nPlay=0;nPlay<nbTime;nPlay++){for(i=0;i<O.length;i++)switch(O[i][0]){case A.cluster:X(n);break;case A.distribute:J(n);break;case A.aggregate:K(n);break;case A.balance:E(n)}if(y=Y(),n){for(avgStudentGroup=parseInt(t/w.length),z=0;z<10;z++){var s=0;for(j=0;j<w.length;j++)if(w[j].length>avgStudentGroup)for(k=w[j].length-1;0<=k;k--)if(1==p&&1==h.reduce(function(e,n){return e+(n===w[j][k])},0)){for(l=0;l<w.length;l++)if(w[l].length-w[j].length<-1&&_[l][g]==_[j][g]){w[l].push(w[j][k]),w[j].splice(k,1),k=-1e6,s++;break}}else if(-1==h.indexOf(w[j][k]))for(l=0;l<w.length;l++)if(w[l].length<avgStudentGroup){w[l].push(w[j][k]),w[j].splice(k,1),k=-1e6,s++;break}0==s&&(z=15),y=Y()}for(i=0;i<O.length;i++)if(O[i][0]==A.balance){E(n);break}}h=[]}P(),L(b("#nbteam").val())},E=function(e){var n,t=0,r=0,s=O[i][1].split(",");for(M=[],F=u=C=0,n=oe(),C=Math.round(u/n),j=0;j<w.length;j++)for(k=0;k<w[j].length;k++)for(l=0;l<s.length;l++)if(0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(s[l],10))){t+=Math.pow(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)-C,2);break}for(F=Math.round(Math.sqrt(t/n)),j=0;j<w.length;j++)for(k=0;k<w[j].length;k++)if(M[j]>C+F/2)for(l=0;l<s.length;l++){if(0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)>C)if(0<(c=ne(i,j,0)).length){$(j,k,c);for(var a=r=M[j]=0;a<w[j].length;a++)for(var o=0;o<s.length;o++)if(0<responses[w[j][a]].length&&-1!=responses[w[j][a]].indexOf(parseInt(s[o],10))){M[j]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}M[j]=M[j]/r;for(a=r=M[c[1]]=0;a<w[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[w[c[1]][a]].length&&-1!=responses[w[c[1]][a]].indexOf(parseInt(s[o],10))){M[c[1]]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(M[c[1]]=M[c[1]]/r,M[j]<C+F/2){k=1e6;break}}}else if(M[j]<C-F/2)for(l=0;l<s.length;l++){var c;if(0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[O[i][2]].answers[parseInt(s[l],10)].answer,10)<C)if(0<(c=ne(i,j,1)).length){for($(j,k,c),a=r=M[j]=0;a<w[j].length;a++)for(o=0;o<s.length;o++)if(0<responses[w[j][a]].length&&-1!=responses[w[j][a]].indexOf(parseInt(s[o],10))){M[j]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}for(M[j]=M[j]/r,a=r=M[c[1]]=0;a<w[c[1]].length;a++)for(o=0;o<s.length;o++)if(0<responses[w[c[1]][a]].length&&-1!=responses[w[c[1]][a]].indexOf(parseInt(s[o],10))){M[c[1]]+=parseInt(questions[O[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(M[c[1]]=M[c[1]]/r,M[j]>C-F/2){k=1e6;break}}}},K=function(e){for(j=0;j<w.length;j++){var n=O[i][1].split(","),t=0,r=0,s=0,a=0;for(l=0;l<n.length;l++){for(s=0,k=0;k<w[j].length;k++)a=l,0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(n[l],10))&&s++;t<s&&(t=s,r=a)}for(void 0===_[j]&&(_[j]=[]),_[j][i]=parseInt(n[r],10),k=0;k<w[j].length;k++)if(0<responses[w[j][k]].length&&-1==responses[w[j][k]].indexOf(_[j][i])&&-1==h.indexOf(w[j][k])){var o=V(j,_[j][i].toString());0<o.length&&($(j,k,o),h.push(w[j][k]))}else 0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(n[r],10))&&h.push(w[j][k]);if(1==e){var c=[];for(k=0;k<w[j].length;k++)if(0<responses[w[j][k]].length&&-1==responses[w[j][k]].indexOf(_[j][i])&&-1==h.indexOf(w[j][k])){for(var u=-1,d=0;d<n.length;d++)if(-1!=responses[w[j][k]].indexOf(parseInt(n[d],10))){u=parseInt(n[d],10);break}var p=ee(j,u);-1<p&&(w[p].push(w[j][k]),h.push(w[j][k]),c.splice(0,0,k))}for(k=0;k<c.length;k++)w[j].splice(c[k],1)}}},J=function(e){for(j=0;j<w.length;j++){var n=O[i][1].split(",");for(k=0;k<w[j].length;k++)if(-1!=h.indexOf(w[j][k]))for(l=0;l<n.length;l++)if(0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(n[l],10))){n.splice(l,1);break}for(k=0;k<w[j].length;k++)if(-1==h.indexOf(w[j][k]))for(nLength=n.length-1,l=nLength;0<=l;l--)0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(n[l],10))&&(n.splice(l,1),h.push(w[j][k]));for(l=0;l<n.length;l++){var t;if(0<(t=V(j,n[l])).length){for(k=0;k<w[j].length;k++)if(-1==h.indexOf(w[j][k])){$(j,k,t);break}}else if(1==p)if(0<(t=Z(j,n[l])).length)for(k=0;k<w[j].length;k++)if(1==h.reduce(function(e,n){return e+(n===w[j][k])},0)){$(j,k,t);break}}}},X=function(e){var n;for(j=0;j<w.length;j++){for(n=-1,nCount=0,k=0;k<w[j].length;k++)for(var t=O[i][1].split(","),r=0;r<t.length;r++)if(0<responses[w[j][k]].length&&-1<responses[w[j][k]].indexOf(parseInt(t[r],10))){nCount++,n=k,nCount<=2&&h.push(w[j][k]);break}if(1==nCount)if(1==e){var s=Q(j,O[i][1]);if(-1<s)w[s].push(w[j][n]),h.push(w[j][n]),w[j].splice(n,1);else if(1==p)if(0<(a=Z(j,O[i][1])).length){for(k=0;k<w[j].length;k++)if(1==h.reduce(function(e,n){return e+(n===w[j][k])},0)){$(j,k,a);break}}else h.pop();else h.pop()}else{var a;if(0<(a=V(j,O[i][1])).length){for(k=0;k<w[j].length;k++)if(-1==h.indexOf(w[j][k])){$(j,k,a);break}}else if(1==p)if(0<(a=Z(j,O[i][1])).length){for(k=0;k<w[j].length;k++)if(1==h.reduce(function(e,n){return e+(n===w[j][k])},0)){$(j,k,a);break}}else h.pop();else h.pop()}}},U=function(){for(var e=b(".student").length,n=Math.ceil(e/w.length),t=0;t<w.length;t++)if(w[t].length>n){for(var r=[],s=w[t].length-1;n<=s;s--)for(var a=0;a<w.length;a++)if((w[a].length<n||a==w.length-1)&&a!=t){w[a].push(w[t][s]),r.push(s);break}for(s=0;s<r.length;s++)w[t].splice(r[s],1)}else if(w[t].length<n)for(r=[],s=w[t].length;s<n;s++)for(a=0;a<w.length;a++)if((w[a].length>n||a==w.length-1)&&a!=t){if(w[t].push(w[a][w[a].length-1]),w[a].splice(w[a].length-1,1),0==w[a].length)return P(),b("#nbteam").val(b("#nbteam").val()-1),L(b("#nbteam").val()),B(),void U();break}P()},$=function(e,n,t){var r=w[e][n];w[e][n]=t[0],w[t[1]][t[2]]=r,h.push(t[0])},Y=function(){var e=[];for(j=0;j<w.length;j++){var n=[];for(k=0;k<w[j].length;k++)n[k]={},n[k].id=w[j][k],n[k].weight=h.reduce(function(e,n){return e+(n===w[j][k])},0);for(n.sort(function(e,n){return n.weight-e.weight}),e[j]=[],k=0;k<w[j].length;k++)w[j][k]=n[k].id,e[j][k]=n[k].weight}return e},V=function(e,n){for(var t=0;t<w.length;t++)if(t!=e)for(var r=0;r<w[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[w[t][r]].length&&-1<responses[w[t][r]].indexOf(parseInt(s[a],10))&&-1==h.indexOf(w[t][r]))return[w[t][r],t,r];return[]},Z=function(e,n){for(var t=0;t<w.length;t++)if(t!=e&&void 0!==_[0]&&_[t][g]==_[e][g])for(var r=0;r<w[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(0<responses[w[t][r]].length&&-1<responses[w[t][r]].indexOf(parseInt(s[a],10))&&1==h.reduce(function(e,n){return e+(n===w[t][r])},0))return[w[t][r],t,r];return[]},Q=function(e,n){for(var t=[],r=0;r<w.length;r++){if(t[r]=0,r!=e)for(var s=0;s<w[r].length;s++)for(var a=n.split(","),i=0;i<a.length;i++)0<responses[w[r][s]].length&&-1<responses[w[r][s]].indexOf(parseInt(a[i],10))&&t[r]++;if(1==t[r])return r}for(r=0;r<w.length;r++)if(0<t[r])return r;return-1},ee=function(e,n){for(var t=[],r=0;r<w.length;r++){for(var s=t[r]=0;s<w[r].length;s++)r!=e&&0<responses[w[r][s]].length&&-1<responses[w[r][s]].indexOf(n)&&t[r]++;if(2<t[r])return r}return-1},ne=function(e,n,t){for(var r=O[e][1].split(","),s=0;s<w.length;s++)for(var a=0;a<w[s].length;a++){if(M[s]<C&&0==t&&s!=n)for(var i=0;i<r.length;i++)if(0<responses[w[s][a]].length&&-1!=responses[w[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)<C&&-1==h.indexOf(w[s][a]))return[w[s][a],s,a];if(1==p&&void 0!==_[0]&&_[n][g]==_[s][g]&&parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)<C&&1==h.reduce(function(e,n){return e+(n===w[s][a])},0))return[w[s][a],s,a]}if(M[s]>C&&1==t&&s!=n)for(i=0;i<r.length;i++)if(0<responses[w[s][a]].length&&-1!=responses[w[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)>C&&-1==h.indexOf(w[s][a]))return[w[s][a],s,a];if(1==p&&void 0!==_[0]&&_[n][g]==_[s][g]&&parseInt(questions[O[e][2]].answers[parseInt(r[i],10)].answer,10)>C&&1==h.reduce(function(e,n){return e+(n===w[s][a])},0))return[w[s][a],s,a]}}return[]},te=function(e,n){if(sr=responses[e],!1===sr)return!1;var t;for(a in t=!(n.oper="any"),n.answers)if(ans=parseInt(n.answers[a]),-1!=b.inArray(ans,sr)){t=!0;break}return t},re=function(){B();var e=[];for(b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),e.push(rslt[1])}),e=se(e);0<e.length;){var n=0,r=[];for(i=1;i<w.length;i++)t=w[i],lt=w[n],t.length<lt.length?(n=i,r=[]):t.length==lt.length&&r.push(i);for(r.push(n);randomTeam=Math.floor(Math.random()*r.length),randomTeam>=r.length;);w[r[randomTeam]].push(e.pop())}P()},se=function(e){var n=[],t=e.slice(0);for(i=t.length;0<i;i--)index=Math.floor(Math.random()*i),n.push(t[index]),t.splice(index,1);return n},ae=function(){b("#addnewcriterion").on("click",H),b("#buildteams").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){R(!0,!1),ce(),b("#protectAll").modal("hide")},250)}),b("#resetteams").on("click",function(){W(),ce(),L(0),L(1),b("#nbteam").val(1)}),b("#replay").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){R(!1,!1),ce(),b("#protectAll").modal("hide")},250)}),b("#assignrandomly").on("click",function(){re(),ce()}),b("#creategroups").on("click",function(){!function(){B();var e=b('<form action="'+window.location+'" method="POST"></form>');for(i=0;i<x.length;i++){var n=x[i],t=w[i],r=b('<input type="hidden" name="teamnames['+i+']" value="'+n+'" />');e.append(r);var s=b('<input type="hidden" name="teams['+i+']" value="'+t.join(",")+'" />');e.append(s)}var a=b('<input type="hidden" name="action" value="create-groups" />'),o=b('<input type="hidden" name="groupingName" value="'+b("#groupingName").val()+'" />'),l=b('<input type="hidden" name="groupingID" value="'+b("#groupingSelect").val()+'" />'),c=b('<input type="hidden" name="inheritGroupingName" value="'+(b("#inheritGroupingName").is(":checked")?1:0)+'" />'),u=b('<input type="hidden" name="nogrouping" value="'+(b("#nogrouping").is(":checked")?1:0)+'" />');e.append(a),e.append(o),e.append(l),e.append(c),e.append(u),b("#createGroupsForm").append(e),e.submit()}(),ce()}),b("#prettify").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){R(!1,!0),ce(),b("#protectAll").modal("hide")},250)}),b("#serie").on("click",function(){b("#protectAll").modal("show"),setTimeout(function(){!function(){b("#nameofgroup").hide();w=[];var e=[];W(),I=d=!0,b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),e.push(rslt[1])});var n=Math.ceil(e.length/x.length),t=0,r=0;for(w[0]=[],i=0;i<e.length;i++)w[t][r]=e[i],n<=++r&&t<x.length-1&&(w[++t]=[],r=0);for(i=0;i<x.length;i++)s=""+(i+1),x[i]=A.serie+" "+"00".substring(0,"00".length-s.length)+s;P()}(),ce(),b("#protectAll").modal("hide")},250)}),b("#dsp_sum_switch").on("click",function(e){b(".box_ok").toggle(),e.stopPropagation()}),b("#aggList").on("click",function(){pe()}),b("#equalize").on("click",function(){U()}),b("#deleteallred").on("click",function(){ge()}),b("#keepallred").on("click",function(){fe()})},ie=function(e,n){for(var t=0;t<O.length;t++)switch(O[t][0]){case A.cluster:for(var r=O[t][1].split(","),s=0;s<r.length;s++)if(e.id==parseInt(r[s],10)){if(count=le(t,n),2<=count)return"color:green;font-weight:bold;";if(1==count)return"color:red;font-weight:bold;"}break;case A.distribute:for(r=O[t][1].split(","),s=0;s<r.length;s++){if(e.id==parseInt(r[s],10)&&0<e.count)return"color:green;font-weight:bold;";if(e.id==parseInt(r[s],10)&&0==e.count)return"color:red;font-weight:bold;"}break;case A.aggregate:if(-1!=(","+O[t][1]+",").indexOf(","+e.id+",")&&void 0!==_[n]){if(e.id==_[n][t])return"background-color:green;color:white;font-weight:bold;font-size:14px;padding:3px;";if(e.id!=_[n][t]&&0==e.count)return"color:green;font-weight:bold;";if(e.id!=_[n][t]&&0<e.count)return"color:red;font-weight:bold;"}break;case A.balance:if(-1==e.id)return M[n]>=C-F/2&&M[n]<=C+F/2?"color:green;font-weight:bold;":"color:red;font-weight:bold;"}return""},oe=function(){for(var e=0,n=0,t=[],r=0;r<O.length;r++)if(O[r][0]==A.balance){t=O[r][1].split(",");break}if(0!=t.length){for(M=[],u=C=0,j=0;j<w.length;j++){for(n=M[j]=0,k=0;k<w[j].length;k++)for(l=0;l<t.length;l++)if(0<responses[w[j][k]].length&&-1!=responses[w[j][k]].indexOf(parseInt(t[l],10))){nAnswer=parseInt(questions[O[r][2]].answers[parseInt(t[l],10)].answer,10),u+=nAnswer,M[j]+=nAnswer,e++,n++;break}M[j]=M[j]/n}return C=u/e,e}},le=function(e,n){for(var t=0,r=O[e][1].split(","),s=0;s<w[n].length;s++)for(var a=0;a<r.length;a++)0!=responses[w[n][s]]&&-1!=responses[w[n][s]].indexOf(parseInt(r[a],10))&&t++;return t},ce=function(){n=ue(),d?(b("#resetteams").prop("disabled",!1),b("#prettify").prop("disabled",!1),b("#equalize").prop("disabled",!1)):(b("#resetteams").prop("disabled",!0),b("#prettify").prop("disabled",!0),b("#equalize").prop("disabled",!0)),n?b("#buildteams").prop("disabled",!1):b("#buildteams").prop("disabled",!0),1<b("#series option").length&&b("#serie").hide()},ue=function(){var n=[],e=[];if(b("#predicate .criterionWrapper").each(function(){var e=D(b(this).children(".criterion"));e.rule=b(this).find(".boolOper").html(),n.push(e)}),0==n.length)return!0;for(c in n){for(a in criterion=n[c],(e=[])[0]=criterion.rule,e[1]="",e[2]=criterion.question,criterion.answers)e[1]=e[1]+criterion.answers[a]+",";if(0<e[1].length&&e[0]!=A.balance)return!0;if(e[0]==A.distribute)return!0;if(e[0]==A.aggregate)return!0;if(e[0]==A.balance){for(qa in questions[criterion.question].answers)if(0==b.isNumeric(questions[e[2]].answers[qa].answer))return!1;return!0}}return!1},de=function(){var e=-1;for(qa in questions){for(answer in questions[qa].answers)e=1==b.isNumeric(questions[qa].answers[answer].answer)?qa:-1;if(-1<e)return e}return e},pe=function(){var e=b("#aggList").val();""!=e?(b(".box_ok").hide(),b(".box_ko").hide(),b("."+e).show()):(b(".box_ok").show(),b(".box_ko").show()),b("#smnu1").removeClass("active"),b("#smnu2").removeClass("active"),b("#smnu1").addClass("active")},he=function(e){var n,t,r=e.length;if(r)for(;--r;)n=e[t=Math.floor(Math.random()*(r+1))],e[t]=e[r],e[r]=n;return e},ge=function(){b(".unanswered .studentdel").click()},fe=function(){b(".answered  .studentdel").click()};return{init:function(){s.get_strings([{key:"criterionquestion",component:"mod_teamup"},{key:"distribute",component:"mod_teamup"},{key:"aggregate",component:"mod_teamup"},{key:"cluster",component:"mod_teamup"},{key:"balance",component:"mod_teamup"},{key:"createteams",component:"mod_teamup"},{key:"analyzeclustercriterion",component:"mod_teamup"},{key:"analyzeclusterwarning",component:"mod_teamup"},{key:"analyzeclustersuccess",component:"mod_teamup"},{key:"analyzeaggregatewarning",component:"mod_teamup"},{key:"noanswer",component:"mod_teamup"},{key:"analyzedistributesuccess",component:"mod_teamup"},{key:"analyzedistributewarning",component:"mod_teamup"},{key:"analyzedistributecriterion",component:"mod_teamup"},{key:"analyzebalancewarning",component:"mod_teamup"},{key:"total",component:"mod_teamup"},{key:"average",component:"mod_teamup"},{key:"standarddeviation",component:"mod_teamup"},{key:"teamupsuccess",component:"mod_teamup"},{key:"teamupwarning",component:"mod_teamup"},{key:"averagesuccess",component:"mod_teamup"},{key:"averagewarning",component:"mod_teamup"},{key:"bornes",component:"mod_teamup"},{key:"teamupsuccessnbr",component:"mod_teamup"},{key:"distributelabel",component:"mod_teamup"},{key:"aggregatelabel",component:"mod_teamup"},{key:"clusterlabel",component:"mod_teamup"},{key:"balancelabel",component:"mod_teamup"},{key:"distributionmode",component:"mod_teamup"},{key:"question",component:"mod_teamup"},{key:"groupTitle",component:"mod_teamup"},{key:"nbGroupSuccess",component:"mod_teamup"},{key:"nbStudent",component:"mod_teamup"},{key:"analyzeaggregatewarningOK",component:"mod_teamup"},{key:"abc",component:"mod_teamup"}]).done(function(e){var n;n=e,A.criterionquestion=n[0],A.distribute=n[1],A.aggregate=n[2],A.cluster=n[3],A.balance=n[4],A.createteams=n[5],A.analyzeclustercriterion=n[6],A.analyzeclusterwarning=n[7],A.analyzeclustersuccess=n[8],A.analyzeaggregatewarning=n[9],A.noanswer=n[10],A.analyzedistributesuccess=n[11],A.analyzedistributewarning=n[12],A.analyzedistributecriterion=n[13],A.analyzebalancewarning=n[14],A.total=n[15],A.average=n[16],A.standarddeviation=n[17],A.teamupsuccess=n[18],A.teamupwarning=n[19],A.averagesuccess=n[20],A.averagewarning=n[21],A.bornes=n[22],A.teamupsuccessnbr=n[23],A.distributeLabel=n[24],A.aggregateLabel=n[25],A.clusterLabel=n[26],A.balanceLabel=n[27],A.distributionMode=n[28],A.question=n[29],A.groupTitle=n[30],A.nbGroupSuccess=n[31],A.nbStudent=n[32],A.analyzeaggregatewarningOK=n[33],A.serie=n[34],r='<div  style="position: relative;" class="criterionWrapper sortable">',r+='  <div class="criterion ui-corner-all">',r+='    <div class="boolOper" style="display:none;">'+A.distributionMode+"</div>",r+='    <div class="operator">'+A.distributionMode+' : <select onChange="$(this).parent().prev().html(this.value);" style="margin-top:4px;">',r+='      <option  value="'+A.aggregate+'">'+A.aggregateLabel+"</option>",r+='      <option  value="'+A.distribute+'">'+A.distributeLabel+"</option>",r+='      <option  value="'+A.cluster+'">'+A.clusterLabel+"</option>",r+='      <option  value="'+A.balance+'">'+A.balanceLabel+"</option>",r+="    </select></div>",r+='    <div class="criterionDelete"></div>',r+="    "+A.question+' : <select class="questions"></select>',r+='    <div class="answers"></div>',r+='    <div class="qreport"></div>',r+="  </div>",r+="</div>",b(".stepper").each(function(){b(this).html();var e="<span id='nbstudentsdsp'> / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")</span>",n=b("<input id='nbteam' type='number' min='1' style='width:60px;height:26px;margin-top:10px;margin-right:5px;' value='1'>"+e);b(this).empty(),b("#placeithere").append(n),b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),b("#btcreate").click(function(){b("#protectAll").modal("show");var e=b("#nbteam").val();setTimeout(function(){L(e),b("#protectAll").modal("hide")},250)})}),b("#id_namingscheme").change(function(){var e=b("#nbteam").val();L(e)}),b("#nbteam").change(function(){var e=b("#nbteam").val();L(e)}),b("legend").click(function(){b(this).nextAll("div").toggle(),b(this).hasClass("myHide")?b(this).attr("class","myShow"):b(this).attr("class","myHide")}),b(".student").each(function(){b(this).width()>v&&(v=b(this).width())}),b(".student").each(function(){b(this).width(v)}),b("#unassigned").on("click",".studentdel",function(e){if(!I){e.stopPropagation(),b(".studentResponse").remove();var n=/studentdel-(\d+)/.exec(b(this).attr("id"))[1];o[n]=students[n],responses[n]=[],delete students[n],b("#student-"+n).remove(),b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),f=b("#unassigned").html(),b(".criterionWrapper").each(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}}),b("#unassigned, #teams").on("mouseup",".student",function(e){if(S)S=!1;else{var n=b('<div class="studentResponse ui-corner-all"></div>'),t=/student-(\d+)/.exec(b(this).attr("id")),r=responses[t[1]];if(r){var s=b('<table class="mod-teamup-table"></table>');for(i in n.append(s),questions){for(j in q=questions[i],qr=[],q.answers)a=q.answers[j],-1!=b.inArray(parseInt(a.id),r)&&qr.push(a.answer);var o=b('<tr><th scope="row">'+q.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");s.append(o)}}else n.html(A.noanswer);b(document.body).append(n),n.css("left",e.pageX),n.css("top",e.pageY);var l,c=function(e){e.target!=n.get(0)&&(n.remove(),b(document).unbind("mousedown",c))};b(document).mousedown(c),b(document).mouseover(function(e){stresponse=b(e.target).closest(".studentResponse"),e.target!=this&&(0==stresponse.length||0<stresponse.length&&n.get(0)!=stresponse.get(0))?null==l&&(l=setTimeout(function(){n.remove()},500)):l&&clearTimeout(l)})}}),b("#teams").on("dblclick",".team > h2",function(e){var n=b(e.target),t=n.html(),r=b('<input type="text" value="'+t+'" />');function s(){var e=b("<h2>"+r.val()+"</h2>");e.width(r.width()),e.height(r.height()),r.replaceWith(e),x[e.parent().index()]=e.html()}r.css("font-size",n.css("font-size")),r.width(n.width()),r.height(n.height()),r.css("border-width","0px");var a=function(e){e.target!=r.get(0)&&(s(),b(document).unbind("mousedown",a))};b(document).mousedown(a),r.keypress(function(e){13==e.keyCode&&(s(),b(document).unbind("mousedown",a))}),n.replaceWith(r),r.focus(),r.select()}),b("#nbteam").change(function(){b("#nbstudentsdsp").html(" / "+b(".student").length+"("+Math.ceil(b(".student").length/parseInt(b("#nbteam").val()))+")"),b(".criterionWrapper").each(function(){G(b(this).closest(".criterionWrapper").children(".criterion"))})}),b("#series").change(function(){window.location.search=N("group",window.location.search)+"&group="+b("#series").val()}),f=b("#unassigned").html(),L(1),H(),b("#predicate").sortable(),ce(),ae()})}}});