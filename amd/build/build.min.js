define(["jquery","jqueryui","core/str"],function(e,n,r){var s,o=85,u=[],d=[],p=[],h=[],g=0,f=!1,b={},v="",w=[],y=[],x=[],T=[],S=[],I=0,A=0,O=0,_=!1,M=!1,C=!1,F=-1,N=function(e,n){var t=n.split("?")[0],r=[],s=-1!==n.indexOf("?")?n.split("?")[1]:"";if(""!==s){for(var a=(r=s.split("&")).length-1;a>=0;a-=1)r[a].split("=")[0]===e&&r.splice(a,1);t=t+"?"+r.join("&")}return t},L=function(n){B();var t=["A-Team","Agent Carter","Agents of S.H.I.E.L.D.","Akatsuki","All-Star Squadron","Alpha Flight","Angel Investigations","Aqua Teen Hunger Force","Arabian Knights","Archer and Armstrong","Armorines","Arrancar","Arrow","Astro Boy","Astro City","Autobots","Avengers","Batman","Battletoads","Ben 10","Beware the Batman","Big Hero 6","Biker Mice from Mars","Bionic Six","Bionic Woman","Birds of Prey","Black Scorpion","Blood Syndicate","Blue Falcon","Champions","Chouseishin","Crystal Gems","Darkstars","Defenders","Dick Tracy","Digvbc","Doom Patrol","Drak Pack","Elementals","Espada 10","Excalibur","Experts of Justice","Fairy Tail Guild","Fantastic 4","Fantastic Force","Fantastic Four","Fearless Defenders","Femforce","Flash","Flash Gordon","Force Works","Forever People","Freedom Fighters","Freedom Force","Freedom Phalanx","Frenetic Five","Future Foundation","Galaxy Angel","Galaxy Trio","Gatchaman","Gatchaman Crowds","Generation X","Gen¹³","Gotei 13","Gotham","Green Lantern Corps","H.A.R.D.Corps","Harbingers","Hero Alliance","Hero Association","Heroes","Heroes for Hire","Inferior Five","Infinity Inc.","Inhumans","Invaders","JLA","Jake 2.0","Jedi","Jessica Jones","Jetman","Justice League","Justice Machine","Kekkaishi","Kickers Inc.","Kiss (band)","Knight Sabers","Lady Blackhawk","Extraordinary Gentlemen","Legends of Tomorrow","Legion of Superheroes","Libra","Lieutenant Marvels","Lois and Clark","Lone Ranger","Lone Ranger Rides Again","Magic Knight Rayearth","Manhattan Clan","Manimal","Marvel Family","Marvel Knights","S.H.I.E.L.D.","Masters of the Universe","Men in Black","Metal Men","Mighty Crusaders","Mighty Mouse","Misfits","Misfits of Science","Mutant X","Mystery Men","Neo-Knights","Nextwave","Nightman","Nova Corps","Omega Men","Overwatch","Planetary","Power Pack","Power Rangers","Preacher","Psi-Force","Ronin Warriors","Runaways","S.H.I.E.L.D.","SWAT Kats","Sailor Senshi","Sailor Senshi","Samurai Pizza Cats","Sarah Solano","Secret Avengers","Secret Six","Section 8","Sentinels of Magic","Seven Soldiers of Victory","Shadowpact","Shi'ar Imperial Guard","Shinigami","Sign Gene","SilverHawks","Sky High","Sora","Sovereign Seven","Spectral Knights","Speedracer","Spider-Friends","Squadron Supreme","Squadron of Justice","Stormwatch","Stormwatch","Straw Hat Pirates","Street Sharks","Suicide Squad","Super Friends","Super Power Friends","Super Sentai","Superboy","Superfriends","Supergirl","Superhuman Samurai","Superman","T.H.U.N.D.E.R. Agents","Team 7","Team Avatar","Team Zenith","Teen Force","Teen Titans","Teenage Mutant Ninja Turtles","Terrific Three","The Aquabats","The Atomics","The Authority","The Avengers","The Beetleborgs","The Care Bears","The Centurions","The DNAgents","The Elite","The End League","The Galaxy Rangers","The Greatest American Hero","The Herculoids","The Impossibles","The Incarnations","The Incredible Hulk","The Incredibles","The Justice Friends","The Legion of Net.Heroes","The Loonatics","The Mighty Ducks","The Mighty Heroes","The N Team","The New League of Heroes","The New Wave","The Order of the Phoenix","The Others","The Outsiders","The Powerpuff Girls","The Six Million Dollar Man","The Specials","The Spectacular Spider-man","The Spider’s Web","The Strangers","The Super Capers","The Super Globetrotters","The Tick","The Tomorrow People","ThunderCats","Thunderbolts","Time Squad","Tokyo Mew Mew","Toxic Crusaders","Turbo-Man","Ultimates","Ultraforce","Uncanny X-Men","Underdog","Underfist","VR Troopers","Watchmen","West Coast Avengers","Wetworks","Wild C.A.T.s","Wolverine and the X-Men","Wonder Woman","X-Factor","X-Force","X-Men","X-Men 2099","X-Statix","Yatterman","Young Allies","Young Avengers","Young Justice","Z Warriors"];if(e("#id_namingscheme").val().indexOf("*")>-1){u.length>n&&(u=u.slice(0,n)),p.length>n&&(p=p.slice(0,n));for(var r=0;r<n;r++){if(sTeamName=e("#id_namingscheme").val(),sFullTeamName=sTeamName,sTeamName.indexOf("#")>-1)sFullTeamName=sTeamName.replace("#",r+1);else if(sTeamName.indexOf("@")>-1){var s="";numChar=r;do{numChar-=26,numChar>=0?s+=String.fromCharCode("A".charCodeAt(0)+0):s+=String.fromCharCode("A".charCodeAt(0)+numChar+26)}while(numChar>=0);sFullTeamName=sTeamName.replace("@",s)}void 0===e("#sumbox_"+r).data("name")||e("#sumbox_"+r).data("name").indexOf("dataname")>-1?sFullTeamName=sFullTeamName.replace("*",""):sFullTeamName=sFullTeamName.replace("*",e("#sumbox_"+r).data("name")),p[r]=sFullTeamName}}else if(u.length>n&&(u=u.slice(0,n)),p.length>n)p=p.slice(0,n);else if(p.length<n){var a=[];for(r=0;r<t.length;r++)a[r]=r;for(a=he(a),r=p.length-1;r<n;r++){if(""!=e("#id_namingscheme").val()?sTeamName=e("#id_namingscheme").val():sTeamName=b.groupTitle,sTeamName.indexOf("#")>-1)sFullTeamName=sTeamName.replace("#",r+1);else if(sTeamName.indexOf("@")>-1){s="";numChar=r;do{numChar-=26,numChar>=0?s+=String.fromCharCode("A".charCodeAt(0)+0):s+=String.fromCharCode("A".charCodeAt(0)+numChar+26)}while(numChar>=0);sFullTeamName=sTeamName.replace("@",s)}else sTeamName.indexOf("$")>-1?sFullTeamName=sTeamName.replace("$",t[a[r]]):sFullTeamName=sTeamName+(r+1);p[r]=sFullTeamName}}P()},W=function(){h=[],S=[],x=[],_=!1;for(var e=0;e<u.length;e++)u[e]=[];f=!1,P()},G=function(n){var t=D(n),r=t.boolOper,s=e("#nbteam").val(),o=0,l="";switch(r){case b.cluster:for(i in students)!1!==responses[i]&&te(i,t)&&o++;l+=b.analyzeclustercriterion.replace("{nbstudent}",o).replace("{nbteam}",s),l+=o/s<2?b.analyzeclusterwarning:b.analyzeclustersuccess;break;case b.aggregate:var c=0;for(i in students)!1!==responses[i]&&o++;for(a in h=[],studAvgByTeam=Math.ceil(o/s),questions[t.question].answers)h.push(a);for(var u=0;u<h.length;u++){for(i in c=0,students)!1!==responses[i]&&-1!=responses[i].indexOf(parseInt(h[u]))&&c++;var d=c%studAvgByTeam,p=parseInt(c/studAvgByTeam);color="",0!=d?(color="red",l+=b.analyzeaggregatewarning.replace("{color}",color).replace("{answer}",questions[t.question].answers[h[u]].answer).replace("{nbstudent}",c).replace("{reste}",d).replace("{nbgroup}",p).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",d)):(color="green",l+=b.analyzeaggregatewarningOK.replace("{color}",color).replace("{answer}",questions[t.question].answers[h[u]].answer).replace("{nbstudent}",c).replace("{reste}",d).replace("{nbgroup}",p).replace("{nbstudentgroup}",studAvgByTeam).replace("{reste}",d))}break;case b.distribute:for(i in students)!1!==responses[i]&&o++;h=[],h=t.answers;for(u=0;u<h.length;u++){for(i in o=0,students)!1!==responses[i]&&(t.answers=[h[u]],te(i,t)&&o++);status=o>=s?b.analyzedistributesuccess.replace("{nbteam}",s):b.analyzedistributewarning.replace("{nbteam}",s),l+=b.analyzedistributecriterion.replace("{answer}",questions[t.question].answers[h[u]].answer).replace("{nbstudent}",o).replace("{status}",status)}break;case b.balance:l="";var h=[];for(a in questions[t.question].answers)h.push(a);t.answers=h;var g=0,f=[];for(i in students)if(aRes=responses[i],!1!==responses[i]&&te(i,t)){for(o++,u=0;u<h.length&&-1===aRes.indexOf(parseInt(h[u],10));u++);if(g+=parseInt(questions[t.question].answers[h[u]].answer),f.push(parseInt(questions[t.question].answers[h[u]].answer)),0==e.isNumeric(questions[t.question].answers[h[u]].answer)){l=b.analyzebalancewarning,o=0;break}}if(""==l){var m=g/o;l=(l=l+"<br>"+b.total+" : <b>"+g+"</b>")+"<br>"+b.average+" : <b>"+Math.ceil(g/o)+"</b>";var k=0;for(i=0;i<f.length;i++)k+=Math.pow(f[i]-m,2);l=l+"<br>"+b.standarddeviation+" : <b>"+Math.ceil(Math.sqrt(k/o))+"</b>"}}0==l.indexOf("<br>")&&(l=l.slice(4)),n.find(".qreport").html(l),n.find(".qreport").css("text-align","left"),ce()},H=function(){if(e("#predicate").length){var n=e(v);for(var t in questions)q=questions[t],n.find(".questions").append('<option value="'+q.id+'">'+q.question.substr(0,120)+"</option>");n.find(".questions").change(function(){!function(n,t){q=questions[n];var r=e("<ul></ul>");for(a in q.answers)answer=q.answers[a],r.append('<li><input style="margin:0" type="checkbox" value="'+answer.id+'"> '+answer.answer+"</input></li>");t.empty().append(r),t.closest(".criterionWrapper").find("ul input,select.oper").change(function(){G(e(this).closest(".criterionWrapper").children(".criterion"))})}(this.value,e(this).nextAll(".answers:first")),"one"==questions[this.value].type?e(this).next(".oper").children("[value='all']").remove():e(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>'),G(e(this).closest(".criterionWrapper").children(".criterion"))}),n.find(".questions *:selected").change(),n.find(".criterion").hover(function(){e(this).children(".criterionDelete").fadeIn(100)},function(){e(this).children(".criterionDelete").fadeOut(100)}),n.find(".criterionDelete").click(function(){e(this).hide(),e(this).closest(".criterionWrapper").slideUp(300,function(){e(this).remove(),ce()})}),n.on("DOMSubtreeModified",".boolOper",function(){var t=e(this).html();t==b.balance||t==b.aggregate?e(this).next().next().next().next().css("display","none"):e(this).next().next().next().next().css("display",""),t==b.balance&&(n.find(".questions").val(de()),n.find(".questions").change()),n.find(".qreport").html(""),G(e(this).closest(".criterionWrapper").children(".criterion"))}),e("#predicate").append(n),n.slideDown(300),n.find(".boolOper").html(""),n.find(".boolOper").html(b.aggregate)}},B=function(){u=[],e(".team").each(function(){var n=e(this),t=e(this).index(),r=[];n.find(".student").each(function(){var n=/student-(\d+)/.exec(e(this).attr("id"));r.push(n[1])}),u[t]=r}),1==f?e(".studentdel").hide():e(".studentdel").show()},P=function(){e("#unassigned").html(s),e("#teams").empty();for(var n=0;n<p.length;n++){var t=e('<div class="team" id="team-'+n+'" title ="'+p[n]+'" />');e("#id_namingscheme").val().indexOf("$")>-1?t.append("<h2 style='height:40px;'>"+p[n]+"</h2>"):t.append("<h2>"+p[n]+"</h2>"),t.width(o+20+10),t.append('<div class="sortable"></div>'),e("#teams").append(t)}var r={connectWith:".sortable",start:function(){g=!0},stop:function(e,n){B(),oe(),d=Y(),P()}};e("#teams .sortable").sortable(r),e("#unassigned .sortable").sortable(r);var i="",c=0;for(n in u){var v=questions;for(k in v)for(l in q=v[k],q.answers)v[k].answers[l].count=0;var w=u[n];t=e("#team-"+n+" > div.sortable");for(j in w){var T=w[j],A=e("#student-"+T),_=responses[T];if(_)for(k in questions){for(m in q=questions[k],nAggSpec=-1,q.answers)if(a=q.answers[m],-1!=e.inArray(parseInt(a.id),_))for(cmdIdx=0;cmdIdx<y.length;cmdIdx++)if(y[cmdIdx][0]==b.aggregate&&y[cmdIdx][2]==q.id&&void 0!==x[n]&&x[n][cmdIdx]==v[k].answers[m].id){nAggSpec=v[k].answers[m].id;break}for(m in q.answers)a=q.answers[m],-1!=e.inArray(parseInt(a.id),_)&&(-1!=nAggSpec?nAggSpec==v[k].answers[m].id&&v[k].answers[m].count++:v[k].answers[m].count++)}A.detach(),t.append(A),-1!=e.inArray(T,h)?A.css("color","green"):(A.css("color",""),d[n])}if(u[0].length>0){for(k in gpok=0,i=i+"<div id='sumbox_"+n+"' data-name={dataname_"+n+"} class='{sumbox_"+n+"} {avgbox_"+n+"} col-sm-4 col-md-3 border-rounded-right mylittlebox'><span style='font-weight:bold;'>"+p[n]+" ("+w.length+")</span><br>",v){for(l in q=v[k],failed=0,values=0,q.answers)color=ie(v[k].answers[l],n),""!=color&&-1!=color.indexOf("red")&&(failed=1),""!=color&&values++,""!=color&&(i=i+v[k].question+" - "+v[k].answers[l].answer+" : <span style='"+color+"'>"+v[k].answers[l].count+"</span><br>"),""!=color&&-1!=color.indexOf("background-color:green")&&(i=(i=i.replace("{avgbox_"+n+"}",v[k].answers[l].answer.split(" ").join("_"))).replace("{dataname_"+n+"}",v[k].answers[l].answer.split(" ").join("_")));0==failed&&values>0?(gpok++,i=i+'<b><span style="color:green">'+v[k].question+" "+b.teamupsuccess+"</span></b><br>"):values>0?(gpok=-1e4,i=i+'<b><span style="color:red">'+v[k].question+" "+b.teamupwarning+"</span></b><br>"):gpok++}if(void 0!==S[n]){var M={id:-1};color=ie(M,n),i=i+b.average+" :<span style='"+color+"'>"+S[n]+"</span><br>",-1!=color.indexOf("red")?(i=i+"<b><span style='color:red'>"+b.averagewarning+"</span></b><br>",gpok=0):(gpok++,i=i+"<b><span style='color:green'>"+b.averagesuccess+"</span></b><br>")}i+="</div>",gpok>0?(c++,i=i.replace("{sumbox_"+n+"}","box_ok")):i=i.replace("{sumbox_"+n+"}","box_ko")}}if(u.length>0&&u[0].length>0){var C;C=e(".student").length,c;var F=c/p.length*100;colSuccess="red",F>80&&(colSuccess="orange"),100==F&&(colSuccess="green"),i=(i=(i+='<div class="col-sm-4 col-md-3 border-rounded-right">')+b.nbGroupSuccess+' : <span style="color:'+colSuccess+';">'+c+"/"+p.length+"</span>")+"<br>"+b.nbStudent+" : "+C,i+="</div>",void 0!==S[n]?(i=i+'<div class="col-sm-4 col-md-3 border-rounded-right">'+b.average+" : "+I+"<br>"+b.standarddeviation+" :"+O+"<br>"+b.bornes+":"+(I-O/2).toFixed(2)+"-"+(I+O/2).toFixed(2)+"</div>",e("#feedback").html(b.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+c+"/"+p.length+"</span><br>"+b.nbStudent+" : "+C+"<br>"+b.average+" : "+I+"<br>"+b.standarddeviation+" :"+O+"<br>"+b.bornes+":"+(I-O/2).toFixed(2)+"-"+(I+O/2).toFixed(2))):e("#feedback").html(b.teamupsuccessnbr+' : <span style="color:'+colSuccess+';">'+c+"/"+p.length+"</span><br>"+b.nbStudent+" : "+C)}else e("#feedback").html("");1==f?e(".studentdel").hide():e(".studentdel").show(),e("#summary").empty(),e("#summary").append(i)},D=function(n){var t={};return t.question=e(n).children(".questions").find("*:selected").val(),t.answers=[],t.oper=e(n).children(".oper").find("*:selected").val(),t.boolOper=e(n).children(".boolOper").html(),e(n).children(".answers").find("input:checked").each(function(){t.answers.push(this.value)}),t},R=function(n,t){var r=0;e("#nameofgroup").show(),1==n&&W(),f=!0,B(),h=[],w=[];var s=[];for(c in _=!0,e("#predicate .criterionWrapper").each(function(){var n=D(e(this).children(".criterion"));n.rule=e(this).find(".boolOper").html(),s.push(n)}),unassignedStudents={},assignedStudents={},e("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),unassignedStudents[rslt[1]]=students[rslt[1]]}),e(".team .student").each(function(){rslt=/student-(\d+)/.exec(this.id),assignedStudents[rslt[1]]=students[rslt[1]]}),e.each(responses,function(e,n){!1===n&&(delete assignedStudents[e],delete unassignedStudents[e]),r++}),y=[],i=0,C=!1,s){for(a in criterion=s[c],strLine="-"+criterion.rule+":"+questions[criterion.question].question+"<br>value:",y[i]=[],y[i][0]=criterion.rule,y[i][1]="",y[i][2]=criterion.question,criterion.answers)answer=questions[criterion.question].answers[criterion.answers[a]],strLine=strLine+answer.answer+"("+criterion.answers[a]+"),",y[i][1]=y[i][1]+criterion.answers[a]+",";if(y[i][0]==b.distribute&&""==y[i][1])for(qa in questions[criterion.question].answers)y[i][1]=y[i][1]+qa+",";if(y[i][0]==b.aggregate){for(qa in C=!0,F=i,y[i][1]="",e("#aggList").empty(),e("#aggList").append(e("<option>",{value:"",text:""})),questions[criterion.question].answers)y[i][1]=y[i][1]+qa+",",e("#aggList").append(e("<option>",{value:questions[criterion.question].answers[qa].answer.split(" ").join("_"),text:questions[criterion.question].answers[qa].answer}));e("#aggList").css("display",""),e("#aggListTitle").css("display","")}if(y[i][0]==b.balance)for(qa in questions[criterion.question].answers)y[i][1]=y[i][1]+qa+",";y[i][1]=y[i][1].replace(new RegExp("[,]*$"),""),i++,strLine=strLine.replace(new RegExp("[,]*$"),"")}for(nMaxStudent=Math.ceil(r/p.length),re(),nbTime=parseInt(6-r/100,10),nbTime<1&&(nbTime=1),nbTime>5&&(nbTime=5),nPlay=0;nPlay<nbTime;nPlay++){for(i=0;i<y.length;i++)switch(y[i][0]){case b.cluster:X(t);break;case b.distribute:J(t);break;case b.aggregate:K(t);break;case b.balance:E(t)}if(d=Y(),t){for(avgStudentGroup=parseInt(r/u.length),z=0;z<10;z++){var o=0;for(j=0;j<u.length;j++)if(u[j].length>avgStudentGroup)for(k=u[j].length-1;k>=0;k--)if(1==C&&1==w.reduce(function(e,n){return e+(n===u[j][k])},0)){for(l=0;l<u.length;l++)if(u[l].length-u[j].length<-1&&x[l][F]==x[j][F]){u[l].push(u[j][k]),u[j].splice(k,1),k=-1e6,o++;break}}else if(-1==w.indexOf(u[j][k]))for(l=0;l<u.length;l++)if(u[l].length<avgStudentGroup){u[l].push(u[j][k]),u[j].splice(k,1),k=-1e6,o++;break}0==o&&(z=15),d=Y()}for(i=0;i<y.length;i++)if(y[i][0]==b.balance){E(t);break}}w=[]}P(),L(e("#nbteam").val())},E=function(e){var n,t=0,r=0,s=y[i][1].split(",");for(S=[],I=0,A=0,O=0,n=oe(),I=Math.round(A/n),j=0;j<u.length;j++)for(k=0;k<u[j].length;k++)for(l=0;l<s.length;l++)if(responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(s[l],10))){t+=Math.pow(parseInt(questions[y[i][2]].answers[parseInt(s[l],10)].answer,10)-I,2);break}for(O=Math.round(Math.sqrt(t/n)),j=0;j<u.length;j++)for(k=0;k<u[j].length;k++)if(S[j]>I+O/2)for(l=0;l<s.length;l++){if(responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[y[i][2]].answers[parseInt(s[l],10)].answer,10)>I)if((c=ne(i,j,0)).length>0){$(j,k,c),S[j]=0,r=0;for(var a=0;a<u[j].length;a++)for(var o=0;o<s.length;o++)if(responses[u[j][a]].length>0&&-1!=responses[u[j][a]].indexOf(parseInt(s[o],10))){S[j]+=parseInt(questions[y[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}S[j]=S[j]/r,S[c[1]]=0,r=0;for(a=0;a<u[c[1]].length;a++)for(o=0;o<s.length;o++)if(responses[u[c[1]][a]].length>0&&-1!=responses[u[c[1]][a]].indexOf(parseInt(s[o],10))){S[c[1]]+=parseInt(questions[y[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(S[c[1]]=S[c[1]]/r,S[j]<I+O/2){k=1e6;break}}}else if(S[j]<I-O/2)for(l=0;l<s.length;l++){var c;if(responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(s[l],10)))if(parseInt(questions[y[i][2]].answers[parseInt(s[l],10)].answer,10)<I)if((c=ne(i,j,1)).length>0){for($(j,k,c),S[j]=0,r=0,a=0;a<u[j].length;a++)for(o=0;o<s.length;o++)if(responses[u[j][a]].length>0&&-1!=responses[u[j][a]].indexOf(parseInt(s[o],10))){S[j]+=parseInt(questions[y[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}for(S[j]=S[j]/r,S[c[1]]=0,r=0,a=0;a<u[c[1]].length;a++)for(o=0;o<s.length;o++)if(responses[u[c[1]][a]].length>0&&-1!=responses[u[c[1]][a]].indexOf(parseInt(s[o],10))){S[c[1]]+=parseInt(questions[y[i][2]].answers[parseInt(s[o],10)].answer,10),r++;break}if(S[c[1]]=S[c[1]]/r,S[j]>I-O/2){k=1e6;break}}}},K=function(e){for(j=0;j<u.length;j++){var n=y[i][1].split(","),t=0,r=0,s=0,a=0;for(l=0;l<n.length;l++){for(s=0,k=0;k<u[j].length;k++)a=l,responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(n[l],10))&&s++;s>t&&(t=s,r=a)}for(void 0===x[j]&&(x[j]=[]),x[j][i]=parseInt(n[r],10),k=0;k<u[j].length;k++)if(responses[u[j][k]].length>0&&-1==responses[u[j][k]].indexOf(x[j][i])&&-1==w.indexOf(u[j][k])){var o=V(j,x[j][i].toString());o.length>0&&($(j,k,o),w.push(u[j][k]))}else responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(n[r],10))&&w.push(u[j][k]);if(1==e){var c=[];for(k=0;k<u[j].length;k++)if(responses[u[j][k]].length>0&&-1==responses[u[j][k]].indexOf(x[j][i])&&-1==w.indexOf(u[j][k])){for(var d=-1,p=0;p<n.length;p++)if(-1!=responses[u[j][k]].indexOf(parseInt(n[p],10))){d=parseInt(n[p],10);break}var h=ee(j,d);h>-1&&(u[h].push(u[j][k]),w.push(u[j][k]),c.splice(0,0,k))}for(k=0;k<c.length;k++)u[j].splice(c[k],1)}}},J=function(e){for(j=0;j<u.length;j++){var n=y[i][1].split(",");for(k=0;k<u[j].length;k++)if(-1!=w.indexOf(u[j][k]))for(l=0;l<n.length;l++)if(responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(n[l],10))){n.splice(l,1);break}for(k=0;k<u[j].length;k++)if(-1==w.indexOf(u[j][k]))for(nLength=n.length-1,l=nLength;l>=0;l--)responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(n[l],10))&&(n.splice(l,1),w.push(u[j][k]));for(l=0;l<n.length;l++){var t;if((t=V(j,n[l])).length>0){for(k=0;k<u[j].length;k++)if(-1==w.indexOf(u[j][k])){$(j,k,t);break}}else if(1==C)if((t=Z(j,n[l])).length>0)for(k=0;k<u[j].length;k++)if(1==w.reduce(function(e,n){return e+(n===u[j][k])},0)){$(j,k,t);break}}}},X=function(e){var n;for(j=0;j<u.length;j++){for(n=-1,nCount=0,k=0;k<u[j].length;k++)for(var t=y[i][1].split(","),r=0;r<t.length;r++)if(responses[u[j][k]].length>0&&responses[u[j][k]].indexOf(parseInt(t[r],10))>-1){nCount++,n=k,nCount<=2&&w.push(u[j][k]);break}if(1==nCount)if(1==e){var s=Q(j,y[i][1]);if(s>-1)u[s].push(u[j][n]),w.push(u[j][n]),u[j].splice(n,1);else if(1==C)if((a=Z(j,y[i][1])).length>0){for(k=0;k<u[j].length;k++)if(1==w.reduce(function(e,n){return e+(n===u[j][k])},0)){$(j,k,a);break}}else w.pop();else w.pop()}else{var a;if((a=V(j,y[i][1])).length>0){for(k=0;k<u[j].length;k++)if(-1==w.indexOf(u[j][k])){$(j,k,a);break}}else if(1==C)if((a=Z(j,y[i][1])).length>0){for(k=0;k<u[j].length;k++)if(1==w.reduce(function(e,n){return e+(n===u[j][k])},0)){$(j,k,a);break}}else w.pop();else w.pop()}}},U=function(){for(var n=e(".student").length,t=Math.ceil(n/u.length),r=0;r<u.length;r++)if(u[r].length>t){for(var s=[],a=u[r].length-1;a>=t;a--)for(var i=0;i<u.length;i++)if((u[i].length<t||i==u.length-1)&&i!=r){u[i].push(u[r][a]),s.push(a);break}for(a=0;a<s.length;a++)u[r].splice(s[a],1)}else if(u[r].length<t)for(s=[],a=u[r].length;a<t;a++)for(i=0;i<u.length;i++)if((u[i].length>t||i==u.length-1)&&i!=r){if(u[r].push(u[i][u[i].length-1]),u[i].splice(u[i].length-1,1),0==u[i].length)return P(),e("#nbteam").val(e("#nbteam").val()-1),L(e("#nbteam").val()),B(),void U();break}P()},$=function(e,n,t){var r=u[e][n];u[e][n]=t[0],u[t[1]][t[2]]=r,w.push(t[0])},Y=function(){var e=[];for(j=0;j<u.length;j++){var n=[];for(k=0;k<u[j].length;k++)n[k]={},n[k].id=u[j][k],n[k].weight=w.reduce(function(e,n){return e+(n===u[j][k])},0);for(n.sort(function(e,n){return n.weight-e.weight}),e[j]=[],k=0;k<u[j].length;k++)u[j][k]=n[k].id,e[j][k]=n[k].weight}return e},V=function(e,n){for(var t=0;t<u.length;t++)if(t!=e)for(var r=0;r<u[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(responses[u[t][r]].length>0&&responses[u[t][r]].indexOf(parseInt(s[a],10))>-1&&-1==w.indexOf(u[t][r]))return[u[t][r],t,r];return[]},Z=function(e,n){for(var t=0;t<u.length;t++)if(t!=e&&void 0!==x[0]&&x[t][F]==x[e][F])for(var r=0;r<u[t].length;r++)for(var s=n.split(","),a=0;a<s.length;a++)if(responses[u[t][r]].length>0&&responses[u[t][r]].indexOf(parseInt(s[a],10))>-1&&1==w.reduce(function(e,n){return e+(n===u[t][r])},0))return[u[t][r],t,r];return[]},Q=function(e,n){for(var t=[],r=0;r<u.length;r++){if(t[r]=0,r!=e)for(var s=0;s<u[r].length;s++)for(var a=n.split(","),i=0;i<a.length;i++)responses[u[r][s]].length>0&&responses[u[r][s]].indexOf(parseInt(a[i],10))>-1&&t[r]++;if(1==t[r])return r}for(r=0;r<u.length;r++)if(t[r]>0)return r;return-1},ee=function(e,n){for(var t=[],r=0;r<u.length;r++){t[r]=0;for(var s=0;s<u[r].length;s++)r!=e&&responses[u[r][s]].length>0&&responses[u[r][s]].indexOf(n)>-1&&t[r]++;if(t[r]>2)return r}return-1},ne=function(e,n,t){for(var r=y[e][1].split(","),s=0;s<u.length;s++)for(var a=0;a<u[s].length;a++){if(S[s]<I&&0==t&&s!=n)for(var i=0;i<r.length;i++)if(responses[u[s][a]].length>0&&-1!=responses[u[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[y[e][2]].answers[parseInt(r[i],10)].answer,10)<I&&-1==w.indexOf(u[s][a]))return[u[s][a],s,a];if(1==C&&void 0!==x[0]&&x[n][F]==x[s][F]&&parseInt(questions[y[e][2]].answers[parseInt(r[i],10)].answer,10)<I&&1==w.reduce(function(e,n){return e+(n===u[s][a])},0))return[u[s][a],s,a]}if(S[s]>I&&1==t&&s!=n)for(i=0;i<r.length;i++)if(responses[u[s][a]].length>0&&-1!=responses[u[s][a]].indexOf(parseInt(r[i],10))){if(parseInt(questions[y[e][2]].answers[parseInt(r[i],10)].answer,10)>I&&-1==w.indexOf(u[s][a]))return[u[s][a],s,a];if(1==C&&void 0!==x[0]&&x[n][F]==x[s][F]&&parseInt(questions[y[e][2]].answers[parseInt(r[i],10)].answer,10)>I&&1==w.reduce(function(e,n){return e+(n===u[s][a])},0))return[u[s][a],s,a]}}return[]},te=function(n,t){if(sr=responses[n],!1===sr)return!1;var r;for(a in t.oper="any",r=!1,t.answers)if(ans=parseInt(t.answers[a]),-1!=e.inArray(ans,sr)){r=!0;break}return r},re=function(){B();var n=[];for(e("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),n.push(rslt[1])}),n=se(n);n.length>0;){var r=0,s=[];for(i=1;i<u.length;i++)t=u[i],lt=u[r],t.length<lt.length?(r=i,s=[]):t.length==lt.length&&s.push(i);s.push(r);do{randomTeam=Math.floor(Math.random()*s.length)}while(randomTeam>=s.length);u[s[randomTeam]].push(n.pop())}P()},se=function(e){var n=[],t=e.slice(0);for(i=t.length;i>0;i--)index=Math.floor(Math.random()*i),n.push(t[index]),t.splice(index,1);return n},ae=function(){e("#addnewcriterion").on("click",H),e("#buildteams").on("click",function(){e("#protectAll").modal("show"),setTimeout(function(){R(!0,!1),ce(),e("#protectAll").modal("hide")},250)}),e("#resetteams").on("click",function(){W(),ce(),L(0),L(1),e("#nbteam").val(1)}),e("#replay").on("click",function(){e("#protectAll").modal("show"),setTimeout(function(){R(!1,!1),ce(),e("#protectAll").modal("hide")},250)}),e("#assignrandomly").on("click",function(){re(),ce()}),e("#creategroups").on("click",function(){!function(){B();var n=e('<form action="'+window.location+'" method="POST"></form>');for(i=0;i<p.length;i++){var t=p[i],r=u[i],s=e('<input type="hidden" name="teamnames['+i+']" value="'+t+'" />');n.append(s);var a=e('<input type="hidden" name="teams['+i+']" value="'+r.join(",")+'" />');n.append(a)}var o=e('<input type="hidden" name="action" value="create-groups" />'),l=e('<input type="hidden" name="groupingName" value="'+e("#groupingName").val()+'" />'),c=e('<input type="hidden" name="groupingID" value="'+e("#groupingSelect").val()+'" />'),d=e('<input type="hidden" name="inheritGroupingName" value="'+(e("#inheritGroupingName").is(":checked")?1:0)+'" />'),h=e('<input type="hidden" name="nogrouping" value="'+(e("#nogrouping").is(":checked")?1:0)+'" />');n.append(o),n.append(l),n.append(c),n.append(d),n.append(h),e("#createGroupsForm").append(n),n.submit()}(),ce()}),e("#prettify").on("click",function(){e("#protectAll").modal("show"),setTimeout(function(){R(!1,!0),ce(),e("#protectAll").modal("hide")},250)}),e("#serie").on("click",function(){e("#protectAll").modal("show"),setTimeout(function(){!function(){e("#nameofgroup").hide();u=[];var n=[];W(),_=!0,f=!0,e("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),n.push(rslt[1])});var t=Math.ceil(n.length/p.length),s=0,a=0;for(u[0]=[],i=0;i<n.length;i++)u[s][a]=n[i],++a>=t&&s<p.length-1&&(u[++s]=[],a=0);for(i=0;i<p.length;i++)r=""+(i+1),p[i]=b.serie+" "+"00".substring(0,"00".length-r.length)+r;P()}(),ce(),e("#protectAll").modal("hide")},250)}),e("#dsp_sum_switch").on("click",function(n){e(".box_ok").toggle(),n.stopPropagation()}),e("#aggList").on("click",function(){pe()}),e("#equalize").on("click",function(){U()}),e("#deleteallred").on("click",function(){ge()}),e("#keepallred").on("click",function(){fe()})},ie=function(e,n){for(var t=0;t<y.length;t++)switch(y[t][0]){case b.cluster:for(var r=y[t][1].split(","),s=0;s<r.length;s++)if(e.id==parseInt(r[s],10)){if(count=le(t,n),count>=2)return"color:green;font-weight:bold;";if(1==count)return"color:red;font-weight:bold;"}break;case b.distribute:for(r=y[t][1].split(","),s=0;s<r.length;s++){if(e.id==parseInt(r[s],10)&&e.count>0)return"color:green;font-weight:bold;";if(e.id==parseInt(r[s],10)&&0==e.count)return"color:red;font-weight:bold;"}break;case b.aggregate:if(-1!=(","+y[t][1]+",").indexOf(","+e.id+",")&&void 0!==x[n]){if(e.id==x[n][t])return"background-color:green;color:white;font-weight:bold;font-size:14px;padding:3px;";if(e.id!=x[n][t]&&0==e.count)return"color:green;font-weight:bold;";if(e.id!=x[n][t]&&e.count>0)return"color:red;font-weight:bold;"}break;case b.balance:if(-1==e.id)return S[n]>=I-O/2&&S[n]<=I+O/2?"color:green;font-weight:bold;":"color:red;font-weight:bold;"}return""},oe=function(){for(var e=0,n=0,t=[],r=0;r<y.length;r++)if(y[r][0]==b.balance){t=y[r][1].split(",");break}if(0!=t.length){for(S=[],I=0,A=0,j=0;j<u.length;j++){for(S[j]=0,n=0,k=0;k<u[j].length;k++)for(l=0;l<t.length;l++)if(responses[u[j][k]].length>0&&-1!=responses[u[j][k]].indexOf(parseInt(t[l],10))){nAnswer=parseInt(questions[y[r][2]].answers[parseInt(t[l],10)].answer,10),A+=nAnswer,S[j]+=nAnswer,e++,n++;break}S[j]=S[j]/n}return I=A/e,e}},le=function(e,n){for(var t=0,r=y[e][1].split(","),s=0;s<u[n].length;s++)for(var a=0;a<r.length;a++)0!=responses[u[n][s]]&&-1!=responses[u[n][s]].indexOf(parseInt(r[a],10))&&t++;return t},ce=function(){M=ue(),_?(e("#resetteams").prop("disabled",!1),e("#prettify").prop("disabled",!1),e("#equalize").prop("disabled",!1)):(e("#resetteams").prop("disabled",!0),e("#prettify").prop("disabled",!0),e("#equalize").prop("disabled",!0)),M?e("#buildteams").prop("disabled",!1):e("#buildteams").prop("disabled",!0),e("#series option").length>1&&e("#serie").hide()},ue=function(){var n=[],t=[];if(e("#predicate .criterionWrapper").each(function(){var t=D(e(this).children(".criterion"));t.rule=e(this).find(".boolOper").html(),n.push(t)}),0==n.length)return!0;for(c in n){for(a in criterion=n[c],(t=[])[0]=criterion.rule,t[1]="",t[2]=criterion.question,criterion.answers)t[1]=t[1]+criterion.answers[a]+",";if(t[1].length>0&&t[0]!=b.balance)return!0;if(t[0]==b.distribute)return!0;if(t[0]==b.aggregate)return!0;if(t[0]==b.balance){for(qa in questions[criterion.question].answers)if(0==e.isNumeric(questions[t[2]].answers[qa].answer))return!1;return!0}}return!1},de=function(){var n=-1;for(qa in questions){for(answer in questions[qa].answers)n=1==e.isNumeric(questions[qa].answers[answer].answer)?qa:-1;if(n>-1)return n}return n},pe=function(){var n=e("#aggList").val();""!=n?(e(".box_ok").hide(),e(".box_ko").hide(),e("."+n).show()):(e(".box_ok").show(),e(".box_ko").show()),e("#smnu1").removeClass("active"),e("#smnu2").removeClass("active"),e("#smnu1").addClass("active")},he=function(e){var n,t,r=e.length;if(r)for(;--r;)n=e[t=Math.floor(Math.random()*(r+1))],e[t]=e[r],e[r]=n;return e},ge=function(){e(".unanswered .studentdel").click()},fe=function(){e(".answered  .studentdel").click()};return{init:function(){r.get_strings([{key:"criterionquestion",component:"mod_teamup"},{key:"distribute",component:"mod_teamup"},{key:"aggregate",component:"mod_teamup"},{key:"cluster",component:"mod_teamup"},{key:"balance",component:"mod_teamup"},{key:"createteams",component:"mod_teamup"},{key:"analyzeclustercriterion",component:"mod_teamup"},{key:"analyzeclusterwarning",component:"mod_teamup"},{key:"analyzeclustersuccess",component:"mod_teamup"},{key:"analyzeaggregatewarning",component:"mod_teamup"},{key:"noanswer",component:"mod_teamup"},{key:"analyzedistributesuccess",component:"mod_teamup"},{key:"analyzedistributewarning",component:"mod_teamup"},{key:"analyzedistributecriterion",component:"mod_teamup"},{key:"analyzebalancewarning",component:"mod_teamup"},{key:"total",component:"mod_teamup"},{key:"average",component:"mod_teamup"},{key:"standarddeviation",component:"mod_teamup"},{key:"teamupsuccess",component:"mod_teamup"},{key:"teamupwarning",component:"mod_teamup"},{key:"averagesuccess",component:"mod_teamup"},{key:"averagewarning",component:"mod_teamup"},{key:"bornes",component:"mod_teamup"},{key:"teamupsuccessnbr",component:"mod_teamup"},{key:"distributelabel",component:"mod_teamup"},{key:"aggregatelabel",component:"mod_teamup"},{key:"clusterlabel",component:"mod_teamup"},{key:"balancelabel",component:"mod_teamup"},{key:"distributionmode",component:"mod_teamup"},{key:"question",component:"mod_teamup"},{key:"groupTitle",component:"mod_teamup"},{key:"nbGroupSuccess",component:"mod_teamup"},{key:"nbStudent",component:"mod_teamup"},{key:"analyzeaggregatewarningOK",component:"mod_teamup"},{key:"abc",component:"mod_teamup"}]).done(function(n){!function(e){b.criterionquestion=e[0],b.distribute=e[1],b.aggregate=e[2],b.cluster=e[3],b.balance=e[4],b.createteams=e[5],b.analyzeclustercriterion=e[6],b.analyzeclusterwarning=e[7],b.analyzeclustersuccess=e[8],b.analyzeaggregatewarning=e[9],b.noanswer=e[10],b.analyzedistributesuccess=e[11],b.analyzedistributewarning=e[12],b.analyzedistributecriterion=e[13],b.analyzebalancewarning=e[14],b.total=e[15],b.average=e[16],b.standarddeviation=e[17],b.teamupsuccess=e[18],b.teamupwarning=e[19],b.averagesuccess=e[20],b.averagewarning=e[21],b.bornes=e[22],b.teamupsuccessnbr=e[23],b.distributeLabel=e[24],b.aggregateLabel=e[25],b.clusterLabel=e[26],b.balanceLabel=e[27],b.distributionMode=e[28],b.question=e[29],b.groupTitle=e[30],b.nbGroupSuccess=e[31],b.nbStudent=e[32],b.analyzeaggregatewarningOK=e[33],b.serie=e[34],v='<div  style="position: relative;" class="criterionWrapper sortable">',v+='  <div class="criterion ui-corner-all">',v+='    <div class="boolOper" style="display:none;">'+b.distributionMode+"</div>",v+='    <div class="operator">'+b.distributionMode+' : <select onChange="$(this).parent().prev().html(this.value);" style="margin-top:4px;">',v+='      <option  value="'+b.aggregate+'">'+b.aggregateLabel+"</option>",v+='      <option  value="'+b.distribute+'">'+b.distributeLabel+"</option>",v+='      <option  value="'+b.cluster+'">'+b.clusterLabel+"</option>",v+='      <option  value="'+b.balance+'">'+b.balanceLabel+"</option>",v+="    </select></div>",v+='    <div class="criterionDelete"></div>',v+="    "+b.question+' : <select class="questions"></select>',v+='    <div class="answers"></div>',v+='    <div class="qreport"></div>',v+="  </div>",v+="</div>"}(n),e(".stepper").each(function(){e(this).html();var n="<span id='nbstudentsdsp'> / "+e(".student").length+"("+Math.ceil(e(".student").length/parseInt(e("#nbteam").val()))+")</span>",t=e("<input id='nbteam' type='number' min='1' style='width:60px;height:26px;margin-top:10px;margin-right:5px;' value='1'>"+n);e(this).empty(),e("#placeithere").append(t),e("#nbstudentsdsp").html(" / "+e(".student").length+"("+Math.ceil(e(".student").length/parseInt(e("#nbteam").val()))+")"),e("#btcreate").click(function(){e("#protectAll").modal("show");var n=e("#nbteam").val();setTimeout(function(){L(n),e("#protectAll").modal("hide")},250)})}),e("#id_namingscheme").change(function(){var n=e("#nbteam").val();L(n)}),e("#nbteam").change(function(){var n=e("#nbteam").val();L(n)}),e("legend").click(function(){e(this).nextAll("div").toggle(),e(this).hasClass("myHide")?e(this).attr("class","myShow"):e(this).attr("class","myHide")}),e(".student").each(function(){e(this).width()>o&&(o=e(this).width())}),e(".student").each(function(){e(this).width(o)}),e("#unassigned").on("click",".studentdel",function(n){if(!f){n.stopPropagation(),e(".studentResponse").remove();var t=/studentdel-(\d+)/.exec(e(this).attr("id"))[1];T[t]=students[t],responses[t]=[],delete students[t],e("#student-"+t).remove(),e("#nbstudentsdsp").html(" / "+e(".student").length+"("+Math.ceil(e(".student").length/parseInt(e("#nbteam").val()))+")"),s=e("#unassigned").html(),e(".criterionWrapper").each(function(){G(e(this).closest(".criterionWrapper").children(".criterion"))})}}),e("#unassigned, #teams").on("mouseup",".student",function(n){if(g)g=!1;else{var t=e('<div class="studentResponse ui-corner-all"></div>'),r=/student-(\d+)/.exec(e(this).attr("id")),s=responses[r[1]];if(s){var o=e('<table class="mod-teamup-table"></table>');for(i in t.append(o),questions){for(j in q=questions[i],qr=[],q.answers)a=q.answers[j],-1!=e.inArray(parseInt(a.id),s)&&qr.push(a.answer);var l=e('<tr><th scope="row">'+q.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");o.append(l)}}else t.html(b.noanswer);e(document.body).append(t),t.css("left",n.pageX),t.css("top",n.pageY);var c,u=function(n){n.target!=t.get(0)&&(t.remove(),e(document).unbind("mousedown",u))};e(document).mousedown(u),e(document).mouseover(function(n){stresponse=e(n.target).closest(".studentResponse"),n.target!=this&&(0==stresponse.length||stresponse.length>0&&t.get(0)!=stresponse.get(0))?null==c&&(c=setTimeout(function(){t.remove()},500)):c&&clearTimeout(c)})}}),e("#teams").on("dblclick",".team > h2",function(n){var t=e(n.target),r=t.html(),s=e('<input type="text" value="'+r+'" />');function a(){var n=e("<h2>"+s.val()+"</h2>");n.width(s.width()),n.height(s.height()),s.replaceWith(n),p[n.parent().index()]=n.html()}s.css("font-size",t.css("font-size")),s.width(t.width()),s.height(t.height()),s.css("border-width","0px");var i=function(n){n.target!=s.get(0)&&(a(),e(document).unbind("mousedown",i))};e(document).mousedown(i),s.keypress(function(n){13==n.keyCode&&(a(),e(document).unbind("mousedown",i))}),t.replaceWith(s),s.focus(),s.select()}),e("#nbteam").change(function(){e("#nbstudentsdsp").html(" / "+e(".student").length+"("+Math.ceil(e(".student").length/parseInt(e("#nbteam").val()))+")"),e(".criterionWrapper").each(function(){G(e(this).closest(".criterionWrapper").children(".criterion"))})}),e("#series").change(function(){window.location.search=N("group",window.location.search)+"&group="+e("#series").val()}),s=e("#unassigned").html(),L(1),H(),e("#predicate").sortable(),ce(),ae()})}}});